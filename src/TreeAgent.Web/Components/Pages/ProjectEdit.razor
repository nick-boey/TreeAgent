@page "/projects/{Id}/edit"
@using TreeAgent.Web.Features.Projects
@using TreeAgent.Web.Features.PullRequests.Data.Entities
@using SystemPromptService = TreeAgent.Web.Features.Agents.SystemPromptService
@inject ProjectService ProjectService
@inject SystemPromptService PromptService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Edit Project</PageTitle>

<h1>Edit Project</h1>

@if (_loading)
{
    <p>Loading...</p>
}
else if (_notFound)
{
    <p>Project not found.</p>
    <a href="projects">Back to Projects</a>
}
else
{
    <form @onsubmit="HandleSubmit">
        <div class="row">
            <div class="col-md-6">
                <h5>General Settings</h5>

                <div class="mb-3">
                    <label for="name" class="form-label">Name</label>
                    <input type="text" class="form-control" id="name" @bind="_name" required />
                </div>

                <div class="mb-3">
                    <label for="localPath" class="form-label">Local Path</label>
                    <input type="text" class="form-control" id="localPath" @bind="_localPath" required placeholder="/path/to/repository" />
                </div>

                <div class="mb-3">
                    <label for="gitHubOwner" class="form-label">GitHub Owner (optional)</label>
                    <input type="text" class="form-control" id="gitHubOwner" @bind="_gitHubOwner" placeholder="owner" />
                </div>

                <div class="mb-3">
                    <label for="gitHubRepo" class="form-label">GitHub Repository (optional)</label>
                    <input type="text" class="form-control" id="gitHubRepo" @bind="_gitHubRepo" placeholder="repo" />
                </div>

                <div class="mb-3">
                    <label for="defaultBranch" class="form-label">Default Branch</label>
                    <input type="text" class="form-control" id="defaultBranch" @bind="_defaultBranch" />
                </div>
            </div>

            <div class="col-md-6">
                <h5>Default System Prompt</h5>
                <p class="text-muted small">Configure the default prompt used for new agents in this project.</p>

                <div class="mb-3">
                    <label for="templateSelect" class="form-label">Use Template</label>
                    <select class="form-select" id="templateSelect" @bind="_selectedTemplateId">
                        <option value="">None (use custom prompt below)</option>
                        @foreach (var template in _templates)
                        {
                            <option value="@template.Id">@template.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label for="customPrompt" class="form-label">Custom Prompt</label>
                    <textarea class="form-control font-monospace" id="customPrompt" rows="8"
                              @bind="_defaultSystemPrompt"
                              placeholder="Enter a custom system prompt or leave empty to use template..."></textarea>
                    <div class="form-text">
                        Use variables like <code>@("{{FEATURE_TITLE}}")</code> for dynamic content.
                        <a href="prompts">View all available variables</a>
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <button type="submit" class="btn btn-primary">Save</button>
        <a href="projects" class="btn btn-secondary">Cancel</a>
    </form>
}

@code {
    [Parameter]
    public string Id { get; set; } = "";

    private bool _loading = true;
    private bool _notFound = false;
    private string _name = "";
    private string _localPath = "";
    private string? _gitHubOwner;
    private string? _gitHubRepo;
    private string _defaultBranch = "main";
    private string? _defaultSystemPrompt;
    private string? _selectedTemplateId;
    private List<SystemPromptTemplate> _templates = [];

    protected override async Task OnInitializedAsync()
    {
        _templates = await PromptService.GetGlobalTemplatesAsync();

        var project = await ProjectService.GetByIdAsync(Id);
        if (project == null)
        {
            _notFound = true;
        }
        else
        {
            _name = project.Name;
            _localPath = project.LocalPath;
            _gitHubOwner = project.GitHubOwner;
            _gitHubRepo = project.GitHubRepo;
            _defaultBranch = project.DefaultBranch;
            _defaultSystemPrompt = project.DefaultSystemPrompt;
            _selectedTemplateId = project.DefaultPromptTemplateId;
        }
        _loading = false;
    }

    private async Task HandleSubmit()
    {
        await ProjectService.UpdateAsync(
            Id,
            _name,
            _localPath,
            _gitHubOwner,
            _gitHubRepo,
            _defaultBranch,
            _defaultSystemPrompt,
            _selectedTemplateId);
        Navigation.NavigateTo("projects");
    }
}

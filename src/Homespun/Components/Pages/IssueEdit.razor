@page "/projects/{ProjectId}/issues/{IssueId}/edit"
@using Fleece.Core.Models
@using Homespun.Features.Fleece.Services
@using Homespun.Features.Navigation
@using Homespun.Features.Projects
@using Homespun.Features.PullRequests.Data.Entities
@inject ProjectService ProjectService
@inject IFleeceService FleeceService
@inject IBreadcrumbService BreadcrumbService
@inject NavigationManager Navigation
@inject ILogger<IssueEdit> Logger
@rendermode InteractiveServer

<PageTitle>Edit Issue - @(_issue?.Title ?? "Loading...")</PageTitle>

@if (_loading)
{
    <p>Loading...</p>
}
else if (_notFound)
{
    <div class="alert alert-warning">
        <h4>Issue Not Found</h4>
        <p>The issue "@IssueId" could not be found in project "@ProjectId".</p>
        <a href="projects/@ProjectId" class="btn btn-secondary">Back to Project</a>
    </div>
}
else if (_project == null)
{
    <div class="alert alert-warning">
        <h4>Project Not Found</h4>
        <p>The project "@ProjectId" could not be found.</p>
        <a href="projects" class="btn btn-secondary">Back to Projects</a>
    </div>
}
else
{
    <div class="flex justify-between items-center mb-3">
        <h1>Edit Issue</h1>
        <span class="badge bg-secondary">@IssueId</span>
    </div>

    <form @onsubmit="HandleSubmit" @onkeydown="HandleKeyDown">
        <div class="grid grid-cols-12">
            <div class="col-span-8">
                <div class="card mb-3">
                    <div class="card-header">Issue Details</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title"
                                   @bind="_title" required />
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="6"
                                      @bind="_description"
                                      placeholder="Implementation details, acceptance criteria..."></textarea>
                        </div>

                        <div class="grid grid-cols-12 mb-3">
                            <div class="col-span-4">
                                <label for="type" class="form-label">Type</label>
                                <select class="form-select" id="type" @bind="_type">
                                    @foreach (var type in Enum.GetValues<IssueType>())
                                    {
                                        <option value="@type">@type</option>
                                    }
                                </select>
                            </div>
                            <div class="col-span-4">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" @bind="_status">
                                    @foreach (var status in Enum.GetValues<IssueStatus>().Where(s => s != IssueStatus.Deleted))
                                    {
                                        <option value="@status">@status</option>
                                    }
                                </select>
                            </div>
                            <div class="col-span-4">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority" @bind="_priority">
                                    <option value="">Not set</option>
                                    <option value="0">P0 - Critical</option>
                                    <option value="1">P1 - High</option>
                                    <option value="2">P2 - Medium</option>
                                    <option value="3">P3 - Low</option>
                                    <option value="4">P4 - Backlog</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="group" class="form-label">Group</label>
                            <input type="text" class="form-control" id="group"
                                   @bind="_group"
                                   placeholder="Optional group for categorization (e.g., core, api, ui)" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-span-4">
                <div class="card mb-3">
                    <div class="card-header">Branch Information</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="workingBranchId" class="form-label">Working Branch ID</label>
                            <input type="text" class="form-control" id="workingBranchId"
                                   @bind="_workingBranchId"
                                   placeholder="Custom branch identifier" />
                            <div class="form-text">Leave empty to auto-generate from title</div>
                        </div>
                        <div class="p-2 bg-bg-tertiary rounded text-sm">
                            <strong>Branch Preview:</strong><br/>
                            <code>@GetBranchPreview()</code>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Metadata</div>
                    <div class="card-body">
                        <dl class="grid grid-cols-12 text-sm mb-0">
                            <dt class="col-span-5 text-text-muted">Created</dt>
                            <dd class="col-span-7">@_issue?.CreatedAt.ToString("g")</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <div class="flex justify-between items-center">
            <div>
                <button type="submit" class="btn btn-primary" disabled="@_isSaving">
                    @if (_isSaving)
                    {
                        <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                    }
                    Save Changes
                </button>
                <a href="projects/@ProjectId" class="btn btn-secondary">Cancel</a>
            </div>
            <div class="text-text-muted text-sm">
                Press <kbd>Ctrl</kbd>+<kbd>Enter</kbd> to save
            </div>
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mt-3">@_errorMessage</div>
        }

        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="alert alert-success mt-3">@_successMessage</div>
        }
    </form>
}

<style>
    kbd {
        background-color: var(--bg-tertiary, #e9ecef);
        border: 1px solid var(--border-color);
        border-radius: 3px;
        padding: 0.1rem 0.3rem;
        font-size: 0.75rem;
    }
</style>

@code {
    [Parameter] public string ProjectId { get; set; } = "";
    [Parameter] public string IssueId { get; set; } = "";

    private bool _loading = true;
    private bool _notFound;
    private bool _isSaving;
    private string? _errorMessage;
    private string? _successMessage;

    private Project? _project;
    private Issue? _issue;

    // Form fields
    private string _title = "";
    private string _description = "";
    private IssueType _type = IssueType.Feature;
    private IssueStatus _status = IssueStatus.Idea;
    private string _priority = "";
    private string _group = "";
    private string _workingBranchId = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        _notFound = false;
        StateHasChanged();

        try
        {
            // Load project
            _project = await ProjectService.GetByIdAsync(ProjectId);
            if (_project == null)
            {
                _loading = false;
                return;
            }

            // Load issue from Fleece
            _issue = await FleeceService.GetIssueAsync(_project.LocalPath, IssueId);
            if (_issue == null)
            {
                _notFound = true;
                _loading = false;
                return;
            }

            // Set breadcrumb context with project, issue, and page info
            await BreadcrumbService.SetContextAsync(new BreadcrumbContext
            {
                ProjectId = ProjectId,
                IssueId = IssueId,
                PageName = "Edit"
            });

            // Initialize form fields
            InitializeFormFromIssue();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load issue {IssueId} for project {ProjectId}", IssueId, ProjectId);
            _errorMessage = $"Failed to load issue: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private void InitializeFormFromIssue()
    {
        if (_issue == null) return;

        _title = _issue.Title;
        _description = _issue.Description ?? "";
        _type = _issue.Type;
        _status = _issue.Status;
        _priority = _issue.Priority?.ToString() ?? "";
        _group = _issue.Group ?? "";
        _workingBranchId = _issue.WorkingBranchId ?? "";
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(_title))
        {
            _errorMessage = "Title is required.";
            return;
        }

        if (_project?.LocalPath == null || _issue == null)
        {
            _errorMessage = "Project or issue not available.";
            return;
        }

        _isSaving = true;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            // Parse priority
            int? priority = null;
            if (int.TryParse(_priority, out var priorityValue))
            {
                priority = priorityValue;
            }

            // Only pass changed values
            var titleToUpdate = _title.Trim() != _issue.Title ? _title.Trim() : null;
            var descToUpdate = _description.Trim() != (_issue.Description ?? "") ? _description.Trim() : null;
            var typeToUpdate = _type != _issue.Type ? _type : (IssueType?)null;
            var statusToUpdate = _status != _issue.Status ? _status : (IssueStatus?)null;
            var priorityToUpdate = priority != _issue.Priority ? priority : null;
            var groupToUpdate = _group.Trim() != (_issue.Group ?? "") ? _group.Trim() : null;
            var workingBranchIdToUpdate = _workingBranchId.Trim() != (_issue.WorkingBranchId ?? "") ? _workingBranchId.Trim() : null;

            // Perform update
            var updated = await FleeceService.UpdateIssueAsync(
                _project.LocalPath,
                _issue.Id,
                title: titleToUpdate,
                status: statusToUpdate,
                type: typeToUpdate,
                description: descToUpdate,
                priority: priorityToUpdate,
                group: groupToUpdate,
                workingBranchId: workingBranchIdToUpdate);

            if (updated == null)
            {
                _errorMessage = "Failed to update issue.";
                return;
            }

            Logger.LogInformation("Successfully updated issue {IssueId}", IssueId);

            // Navigate back to project detail
            Navigation.NavigateTo($"projects/{ProjectId}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save issue {IssueId}", IssueId);
            _errorMessage = $"Failed to save: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && e.CtrlKey)
        {
            _ = HandleSubmit();
        }
    }

    private string GetBranchPreview()
    {
        var type = _type.ToString().ToLowerInvariant();
        // Use working branch ID if set, otherwise generate from title
        var branchId = !string.IsNullOrWhiteSpace(_workingBranchId)
            ? _workingBranchId.Trim()
            : SanitizeForBranch(_title);

        // If group is set, use group-based format; otherwise use issues/ prefix
        if (!string.IsNullOrWhiteSpace(_group))
        {
            return $"{_group.Trim()}/{type}/{branchId}+{IssueId}";
        }

        return $"issues/{type}/{branchId}+{IssueId}";
    }

    private static string SanitizeForBranch(string input)
    {
        if (string.IsNullOrWhiteSpace(input)) return "<title>";

        // Convert to lowercase, replace spaces with hyphens, remove special chars
        var sanitized = input.ToLowerInvariant()
            .Replace(" ", "-")
            .Replace("_", "-");

        // Remove any character that isn't alphanumeric or hyphen
        sanitized = System.Text.RegularExpressions.Regex.Replace(sanitized, "[^a-z0-9-]", "");

        // Remove consecutive hyphens
        sanitized = System.Text.RegularExpressions.Regex.Replace(sanitized, "-+", "-");

        // Trim hyphens from start and end
        return sanitized.Trim('-');
    }
}

@page "/projects/create"
@using Homespun.Features.Projects
@inject ProjectService ProjectService
@inject NavigationManager Navigation
@inject ILogger<ProjectCreate> Logger
@rendermode InteractiveServer

<PageTitle>New Project</PageTitle>

<h1>New Project</h1>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <button class="nav-link @(_mode == "github" ? "active" : "")" 
                type="button"
                @onclick="@(() => _mode = "github")">
            GitHub Repository
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(_mode == "local" ? "active" : "")" 
                type="button"
                @onclick="@(() => _mode = "local")">
            Local Repository
        </button>
    </li>
</ul>

<form @onsubmit="HandleSubmit">
    @if (_mode == "github")
    {
        <div class="mb-3">
            <label for="ownerRepo" class="form-label">GitHub Repository</label>
            <input type="text" class="form-control" id="ownerRepo" @bind="_ownerRepo" required
                   placeholder="owner/repository" />
            <div class="form-text">
                Enter the GitHub repository in owner/repository format (e.g., microsoft/vscode).
                The repository will be cloned to ~/.homespun/src/&lt;repository&gt;/&lt;default-branch&gt;.
            </div>
        </div>
    }
    else
    {
        <div class="mb-3">
            <label for="projectName" class="form-label">Project Name</label>
            <input type="text" class="form-control" id="projectName" @bind="_projectName" required
                   placeholder="my-project" />
            <div class="form-text">
                Use only letters, numbers, hyphens, and underscores.
                A new git repository will be created at ~/.homespun/src/&lt;name&gt;/&lt;branch&gt;.
            </div>
        </div>
        <div class="mb-3">
            <label for="defaultBranch" class="form-label">Default Branch</label>
            <input type="text" class="form-control" id="defaultBranch" @bind="_defaultBranch"
                   placeholder="main" />
            <div class="form-text">
                Leave blank to use "main" as the default branch.
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @_errorMessage
        </div>
    }

    <button type="submit" class="btn btn-primary" disabled="@_isSubmitting">
        @if (_isSubmitting)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <span>Creating...</span>
        }
        else
        {
            <span>Create</span>
        }
    </button>
    <a href="projects" class="btn btn-secondary">Cancel</a>
</form>

@code {
    private string _mode = "github";
    private string _ownerRepo = "";
    private string _projectName = "";
    private string _defaultBranch = "main";
    private string? _errorMessage;
    private bool _isSubmitting;

    private async Task HandleSubmit()
    {
        Logger.LogInformation("HandleSubmit called: mode={Mode}, ownerRepo={OwnerRepo}, projectName={ProjectName}", 
            _mode, _ownerRepo, _projectName);
        
        _errorMessage = null;
        _isSubmitting = true;

        try
        {
            CreateProjectResult result;
            
            if (_mode == "github")
            {
                Logger.LogInformation("Creating GitHub project from {OwnerRepo}", _ownerRepo);
                result = await ProjectService.CreateAsync(_ownerRepo);
                Logger.LogInformation("CreateAsync returned: Success={Success}, ErrorMessage={ErrorMessage}", 
                    result.Success, result.ErrorMessage);
            }
            else
            {
                var branch = string.IsNullOrWhiteSpace(_defaultBranch) ? "main" : _defaultBranch.Trim();
                Logger.LogInformation("Creating local project {ProjectName} with branch {Branch}", _projectName, branch);
                result = await ProjectService.CreateLocalAsync(_projectName.Trim(), branch);
                Logger.LogInformation("CreateLocalAsync returned: Success={Success}, ErrorMessage={ErrorMessage}", 
                    result.Success, result.ErrorMessage);
            }

            if (result.Success)
            {
                Logger.LogInformation("Project created successfully, navigating to projects list");
                Navigation.NavigateTo("projects");
            }
            else
            {
                Logger.LogWarning("Project creation failed: {ErrorMessage}", result.ErrorMessage);
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Exception in HandleSubmit");
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
            Logger.LogInformation("HandleSubmit completed, isSubmitting={IsSubmitting}", _isSubmitting);
        }
    }
}

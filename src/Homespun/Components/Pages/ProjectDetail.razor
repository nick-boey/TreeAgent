@page "/projects/{Id}"
@using Homespun.Features.Beads
@using Homespun.Features.Beads.Data
@using Homespun.Features.Beads.Services
@using Homespun.Features.GitHub
@using Homespun.Features.OpenCode.Services
@using Homespun.Features.Projects
@using Homespun.Features.PullRequests
@using Homespun.Features.PullRequests.Data
@using Homespun.Features.PullRequests.Data.Entities
@inject ProjectService ProjectService
@inject PullRequestDataService PullRequestDataService
@inject PullRequestWorkflowService PullRequestWorkflowService
@inject IBeadsService BeadsService
@inject IDataStore DataStore
@inject IGitHubService GitHubService
@inject ILogger<ProjectDetail> Logger
@inject NavigationManager NavigationManager
@inject ITestAgentService? TestAgentService
@rendermode InteractiveServer

<PageTitle>@(_project?.Name ?? "Project")</PageTitle>

@if (_project == null)
{
    <p>Loading...</p>
}
else
{
    <div class="project-layout">
        <div class="timeline-column">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1>@_project.Name</h1>
                <div>
                    <a href="projects/@Id/edit" class="btn btn-outline-secondary btn-sm">Edit Project</a>
                </div>
            </div>

            <div class="timeline-list">
                @* Past PRs - from GitHub (oldest to newest) *@
                @if (_isLoadingPastPRs)
                {
                    <div class="timeline-section-header">
                        <span class="spinner-border spinner-border-sm ms-2" role="status"></span>
                    </div>
                }
                else if (_pastPRs != null && _pastPRs.Count > 0)
                {
                    var orderedPastPRs = _pastPRs.OrderBy(p => p.Time).ToList();
                    var hiddenCount = Math.Max(0, orderedPastPRs.Count - _pastPRsDisplayCount);
                    var visiblePastPRs = orderedPastPRs.Skip(hiddenCount).ToList();

                    @if (hiddenCount > 0)
                    {
                        <button class="timeline-action-btn" @onclick="LoadMorePastPRs">
                            <div class="item-graph">
                                <div class="graph-line graph-line-top hidden"></div>
                                <div class="graph-node status-load-more">...</div>
                                <div class="graph-line graph-line-bottom"></div>
                            </div>
                            <div class="item-body">
                                <span
                                    class="item-title action-title">@hiddenCount older PRs (load @Math.Min(5, hiddenCount) more)</span>
                            </div>
                        </button>
                    }

                    @for (var i = 0; i < visiblePastPRs.Count; i++)
                    {
                        var prWithTime = visiblePastPRs[i];
                        var isFirstInTimeline = i == 0 && hiddenCount == 0;
                        <WorkItem Title="@prWithTime.PullRequest.Title"
                                  Number="@prWithTime.PullRequest.Number"
                                  Url="@prWithTime.PullRequest.HtmlUrl"
                                  StatusColor="@GetPastPRStatusColor(prWithTime.PullRequest.Status)"
                                  StatusTooltip="@prWithTime.PullRequest.Status.ToString()"
                                  Subtitle="@GetPastPRSubtitle(prWithTime.PullRequest)"
                                  IsFirst="@isFirstInTimeline"
                                  IsLast="false"/>
                    }
                }

                @* Current PRs - from database *@
                @if (_pastPRs != null && _pastPRs.Count > 0)
                {
                    <div class="timeline-section-label">
                        <div class="label-graph">
                            <div class="graph-line"></div>
                        </div>
                        <div class="label-text">Current</div>
                        @if (GetTotalCurrentCount() > 0)
                        {
                            <span class="section-count">@GetTotalCurrentCount()</span>
                        }
                    </div>
                }
                @if ((_rootPullRequests == null || _rootPullRequests.Count == 0) && (_inProgressIssues == null || _inProgressIssues.Count == 0))
                {
                    <div class="timeline-section-label">
                        <div class="label-graph">
                            <div class="graph-line"></div>
                        </div>
                        <div class="label-text">No open pull requests</div>
                    </div>
                }
                else
                {
                    @for (var i = 0; i < _flattenedCurrentPRs.Count; i++)
                    {
                        var pr = _flattenedCurrentPRs[i];
                        <WorkItem Title="@pr.PullRequest.Title"
                                  Number="@pr.PullRequest.GitHubPRNumber"
                                  StatusColor="@GetCurrentPRStatusColor(pr.PullRequest.Status)"
                                  StatusTooltip="@pr.PullRequest.Status.ToString()"
                                  Subtitle="@GetCurrentPRSubtitle(pr.PullRequest)"
                                  IndentLevel="@pr.Level"
                                  IsSelected="@(_selectedPullRequestId == pr.PullRequest.Id)"
                                  IsClickable="true"
                                  IsFirst="false"
                                  IsLast="false"
                                  OnClick="@(() => SelectPullRequest(pr.PullRequest.Id))"/>
                    }

                    @* In-progress Beads Issues (shown in Current section) *@
                    @if (_inProgressIssues != null)
                    {
                        @for (var i = 0; i < _inProgressIssues.Count; i++)
                        {
                            var issueWithMeta = _inProgressIssues[i];
                            <WorkItem Title="@issueWithMeta.Issue.Title"
                                      StatusColor="@GetBeadsIssueStatusColor(issueWithMeta.Issue)"
                                      StatusTooltip="@GetBeadsIssueStatusTooltip(issueWithMeta.Issue)"
                                      Subtitle="@GetBeadsIssueSubtitle(issueWithMeta)"
                                      IndentLevel="@issueWithMeta.Depth"
                                      IsSelected="@(_selectedBeadsIssueId == issueWithMeta.Issue.Id)"
                                      IsClickable="true"
                                      IsFirst="false"
                                      IsLast="false"
                                      OnClick="@(() => SelectBeadsIssue(issueWithMeta.Issue.Id))"/>
                        }
                    }
                }

                @* Future Issues - from beads *@
                <div class="timeline-section-label">
                    <div class="label-graph">
                        <div class="graph-line"></div>
                    </div>
                    <div class="label-text">Future</div>
                    @if (_openIssues != null && _openIssues.Count > 0)
                    {
                        <span class="section-count">@_openIssues.Count</span>
                    }
                </div>
                @if (_openIssues == null || _openIssues.Count == 0)
                {
                    <a href="projects/@Id/issues/create" class="add-item">
                        <div class="item-graph">
                            <div class="graph-line graph-line-top"></div>
                            <div class="graph-node status-add">+</div>
                            <div class="graph-line graph-line-bottom hidden"></div>
                        </div>
                        <div class="item-body">
                            <span class="item-title add-title">Add an issue...</span>
                        </div>
                    </a>
                }
                else
                {
                    @for (var i = 0; i < _openIssues.Count; i++)
                    {
                        var issueWithMeta = _openIssues[i];
                        <WorkItem Title="@issueWithMeta.Issue.Title"
                                  StatusColor="@GetBeadsIssueStatusColor(issueWithMeta.Issue)"
                                  StatusTooltip="@GetBeadsIssueStatusTooltip(issueWithMeta.Issue)"
                                  Subtitle="@GetBeadsIssueSubtitle(issueWithMeta)"
                                  IndentLevel="@issueWithMeta.Depth"
                                  IsSelected="@(_selectedBeadsIssueId == issueWithMeta.Issue.Id)"
                                  IsClickable="true"
                                  IsFirst="false"
                                  IsLast="false"
                                  OnClick="@(() => SelectBeadsIssue(issueWithMeta.Issue.Id))"/>
                    }

                    <a href="projects/@Id/issues/create" class="add-item">
                        <div class="item-graph">
                            <div class="graph-line graph-line-top"></div>
                            <div class="graph-node status-add">+</div>
                            <div class="graph-line graph-line-bottom hidden"></div>
                        </div>
                        <div class="item-body">
                            <span class="item-title add-title">Add an issue...</span>
                        </div>
                    </a>
                }
            </div>
        </div>

        <div class="detail-column">
            @if (_selectedPullRequest != null)
            {
                <CurrentPullRequestDetailPanel PullRequest="_selectedPullRequest"
                                               OnActionCompleted="RefreshData"
                                               OnClose="ClearSelection"/>
            }
            else if (_selectedBeadsIssue != null)
            {
                <BeadsIssueDetailPanel ProjectId="@Id"
                                       Issue="_selectedBeadsIssue.Issue"
                                       Metadata="_selectedBeadsIssue.Metadata"
                                       OnActionCompleted="RefreshData"
                                       OnClose="ClearSelection"/>
            }
            else
            {
                <div class="card">
                    <div class="card-header">Project Info</div>
                    <div class="card-body">
                        <dl class="info-list">
                            <dt>Local Path</dt>
                            <dd><code>@_project.LocalPath</code></dd>
                            <dt>Default Branch</dt>
                            <dd>@_project.DefaultBranch</dd>
                            @if (!string.IsNullOrEmpty(_project.GitHubOwner) && !string.IsNullOrEmpty(_project.GitHubRepo))
                            {
                                <dt>GitHub</dt>
                                <dd>
                                    <a href="https://github.com/@_project.GitHubOwner/@_project.GitHubRepo"
                                       target="_blank">
                                        @_project.GitHubOwner/@_project.GitHubRepo
                                    </a>
                                    @if (_isSyncingPRs)
                                    {
                                        <span class="badge bg-info ms-2">
                                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                            Syncing...
                                        </span>
                                    }
                                    else if (_tokenMissing)
                                    {
                                        <span class="badge bg-warning text-dark ms-2"
                                              title="Set GITHUB_TOKEN environment variable">Token missing</span>
                                        <button class="btn btn-sm btn-link p-0 ms-1" @onclick="SyncPullRequestsAsync">
                                            Retry
                                        </button>
                                    }
                                    else if (_syncError != null)
                                    {
                                        <span class="badge bg-danger ms-2" title="@_syncError">Sync failed</span>
                                        <button class="btn btn-sm btn-link p-0 ms-1" @onclick="SyncPullRequestsAsync">
                                            Retry
                                        </button>
                                    }
                                    else if (_lastSyncResult != null)
                                    {
                                        <span class="badge bg-success ms-2"
                                              title="Imported: @_lastSyncResult.Imported, Updated: @_lastSyncResult.Updated, Removed: @_lastSyncResult.Removed">
                                            Synced
                                        </span>
                                        <button class="btn btn-sm btn-link p-0 ms-1" @onclick="SyncPullRequestsAsync">
                                            Refresh
                                        </button>
                                    }
                                </dd>
                            }
                        </dl>
                        
                        @* DEBUG-only test agent controls *@
                        @if (IsDebugBuild && TestAgentService != null)
                        {
                            <div class="border-top mt-3 pt-3">
                                <h6 class="text-muted mb-2">Debug Tools</h6>
                                
                                @if (_testAgentStatus == null)
                                {
                                    <button class="btn btn-outline-warning btn-sm" 
                                            @onclick="StartTestAgent" 
                                            disabled="@_isTestAgentLoading">
                                        @if (_isTestAgentLoading)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        Start Test Agent
                                    </button>
                                }
                                else
                                {
                                    <div class="mb-2">
                                        <span class="badge bg-success">Test Agent Running</span>
                                    </div>
                                    <div class="mb-2 small">
                                        <div><strong>Server:</strong> <code>@_testAgentStatus.ServerUrl</code></div>
                                        <div><strong>Session:</strong> <code>@_testAgentStatus.SessionId</code></div>
                                        <div><strong>Worktree:</strong> <code class="text-break">@_testAgentStatus.WorktreePath</code></div>
                                    </div>
                                    <div class="btn-group btn-group-sm mb-2">
                                        <a href="@(_testAgentStatus.WebViewUrl ?? _testAgentStatus.ServerUrl)" target="_blank" class="btn btn-outline-primary">
                                            Open Web View
                                        </a>
                                        <button class="btn btn-outline-info" @onclick="VerifySession" disabled="@_isVerifying">
                                            @if (_isVerifying)
                                            {
                                                <span class="spinner-border spinner-border-sm me-1"></span>
                                            }
                                            Verify Session
                                        </button>
                                        <button class="btn btn-outline-danger" @onclick="StopTestAgent" disabled="@_isTestAgentLoading">
                                            Stop
                                        </button>
                                    </div>
                                    
                                    @if (_verificationResult != null)
                                    {
                                        <div class="p-2 border rounded small">
                                            <strong>Session Verification:</strong>
                                            @if (_verificationResult.SessionFound)
                                            {
                                                <span class="text-success ms-1">Found</span>
                                                <div>Title: @_verificationResult.SessionTitle</div>
                                            }
                                            else
                                            {
                                                <span class="text-danger ms-1">Not Found</span>
                                                @if (!string.IsNullOrEmpty(_verificationResult.Error))
                                                {
                                                    <div class="text-danger">@_verificationResult.Error</div>
                                                }
                                            }
                                            <div>Total sessions: @_verificationResult.TotalSessions</div>
                                            @if (_verificationResult.AllSessionIds.Count > 0)
                                            {
                                                <div>IDs: @string.Join(", ", _verificationResult.AllSessionIds.Take(3))@(_verificationResult.AllSessionIds.Count > 3 ? "..." : "")</div>
                                            }
                                        </div>
                                    }
                                }
                                
                                @if (!string.IsNullOrEmpty(_testAgentError))
                                {
                                    <div class="alert alert-danger mt-2 py-1 px-2 small mb-0">@_testAgentError</div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
    .project-layout {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: var(--spacing-md);
        align-items: start;
    }

    @@media (max-width: 900px) {
        .project-layout {
            grid-template-columns: 1fr;
        }

        .detail-column {
            order: -1;
        }
    }

    .timeline-column {
        min-width: 0;
    }

    .detail-column {
        position: sticky;
        top: var(--spacing-md);
    }

    .timeline-list {
        display: flex;
        flex-direction: column;
    }

    .timeline-section-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) 0;
        font-size: 0.75rem;
        font-weight: var(--font-weight-semibold);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .section-count {
        background: var(--bg-tertiary);
        padding: 0.125rem 0.375rem;
        border-radius: var(--radius-full);
        font-size: 0.6875rem;
    }

    /* Inline section label with continuous graph line */
    .timeline-section-label {
        display: flex;
        align-items: stretch;
        gap: var(--spacing-sm);
        padding: 0 var(--spacing-sm);
        min-height: 1.25rem;
    }

    .timeline-section-label .label-graph {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 16px;
        flex-shrink: 0;
    }

    .timeline-section-label .graph-line {
        width: 2px;
        flex: 1;
        background-color: var(--border-color);
    }

    .timeline-section-label .label-text {
        display: flex;
        align-items: center;
        font-size: 0.6875rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    
    .timeline-section-label .section-count {
        margin-left: var(--spacing-xs);
    }

    /* Timeline action buttons (load more, add item) */
    .timeline-action-btn,
    .add-item {
        display: flex;
        align-items: stretch;
        gap: var(--spacing-sm);
        padding: 0 var(--spacing-sm);
        border-radius: var(--radius-sm);
        transition: background-color var(--transition-fast);
        min-height: 2.25rem;
        text-decoration: none;
        cursor: pointer;
        background: transparent;
        border: none;
        width: 100%;
        text-align: left;
    }

    .timeline-action-btn:hover,
    .add-item:hover {
        background-color: var(--bg-hover);
    }

    .timeline-action-btn .item-graph,
    .add-item .item-graph {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 16px;
        flex-shrink: 0;
    }

    .timeline-action-btn .graph-line,
    .add-item .graph-line {
        width: 2px;
        flex: 1;
        background-color: var(--border-color);
    }

    .timeline-action-btn .graph-line.hidden,
    .add-item .graph-line.hidden {
        visibility: hidden;
    }

    .timeline-action-btn .graph-line-top,
    .add-item .graph-line-top {
        min-height: 4px;
    }

    .timeline-action-btn .graph-line-bottom,
    .add-item .graph-line-bottom {
        min-height: 4px;
    }

    .timeline-action-btn .graph-node,
    .add-item .graph-node {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
        border: 2px solid var(--bg-primary);
        box-sizing: content-box;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.5rem;
        font-weight: bold;
        color: white;
    }

    .timeline-action-btn .graph-node.status-load-more {
        background-color: var(--text-muted);
        font-size: 0.625rem;
        letter-spacing: -0.5px;
    }

    .add-item .graph-node.status-add {
        background-color: var(--color-ocean);
    }

    .timeline-action-btn .item-body,
    .add-item .item-body {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: var(--spacing-xs) 0;
    }

    .timeline-action-btn .action-title,
    .add-item .add-title {
        font-size: 0.8125rem;
        color: var(--text-muted);
        font-style: italic;
    }

    .timeline-action-btn:hover .action-title {
        color: var(--text-primary);
    }

    .add-item:hover .add-title {
        color: var(--color-ocean);
    }

    .info-list {
        margin: 0;
        font-size: 0.8125rem;
    }

    .info-list dt {
        font-weight: var(--font-weight-medium);
        color: var(--text-secondary);
        margin-top: var(--spacing-sm);
    }

    .info-list dt:first-child {
        margin-top: 0;
    }

    .info-list dd {
        margin: 0;
        margin-top: 0.125rem;
    }

</style>

@code {
    [Parameter] public string Id { get; set; } = "";

    private Project? _project;
    private List<PullRequest>? _rootPullRequests;
    private List<FlattenedPR> _flattenedCurrentPRs = [];
    private PullRequest? _selectedPullRequest;
    private string? _selectedPullRequestId;
    private BeadsIssueWithMetadata? _selectedBeadsIssue;
    private string? _selectedBeadsIssueId;
    private bool _isSyncingPRs;
    private bool _isLoadingPastPRs;
    private bool _tokenMissing;
    private string? _syncError;
    private SyncResult? _lastSyncResult;
    private List<PullRequestWithTime>? _pastPRs;
    private List<BeadsIssueWithMetadata>? _openIssues;
    private List<BeadsIssueWithMetadata>? _inProgressIssues;
    private int _pastPRsDisplayCount = 10;

    // Debug-only fields (always declared, only used in DEBUG builds)
    private TestAgentStatus? _testAgentStatus;
    private bool _isTestAgentLoading;
    private bool _isVerifying;
    private string? _testAgentError;
    private SessionVerificationResult? _verificationResult;

#if DEBUG
    private static bool IsDebugBuild => true;
#else
    private static bool IsDebugBuild => false;
#endif

    private record FlattenedPR(PullRequest PullRequest, int Level);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        
        // Check for existing test agent (DEBUG builds only)
        if (IsDebugBuild && TestAgentService != null && _project != null)
        {
            _testAgentStatus = TestAgentService.GetTestAgentStatus(_project.Id);
        }
        
        // Start sync and load past PRs after project is loaded
        // Using Task.Run to not block the initial render
        if (_project != null)
        {
            _ = Task.Run(async () =>
            {
                await InvokeAsync(async () =>
                {
                    await SyncPullRequestsAsync();
                    await LoadPastPRsAsync();
                });
            });
        }
    }

    private async Task LoadData()
    {
        _project = await ProjectService.GetByIdAsync(Id);
        if (_project != null)
        {
            _rootPullRequests = await PullRequestDataService.GetTreeAsync(Id);
            _flattenedCurrentPRs = FlattenPRs(_rootPullRequests ?? []);

            try
            {
                // Load beads issues from the CLI
                var allIssues = await BeadsService.ListIssuesAsync(_project.LocalPath);
                
                // Load local metadata for matching
                var metadataList = DataStore.GetBeadsIssueMetadataByProject(Id);
                var metadataLookup = metadataList.ToDictionary(m => m.IssueId);
                
                // Convert to BeadsIssueWithMetadata
                var issuesWithMeta = allIssues.Select((issue, index) => new BeadsIssueWithMetadata
                {
                    Issue = issue,
                    Metadata = metadataLookup.GetValueOrDefault(issue.Id),
                    Time = index,
                    Depth = 0 // Flat for now; could calculate from dependencies
                }).ToList();
                
                // Separate in-progress issues (InProgress, Blocked with awaiting-pr label) from open issues
                // Filter out issues that have a hsp:pr-* label (they are linked to a PR and shown there instead)
                _inProgressIssues = issuesWithMeta
                    .Where(i => i.Issue.Status == BeadsIssueStatus.InProgress ||
                               (i.Issue.Status == BeadsIssueStatus.Blocked && i.Issue.Labels.Contains("awaiting-pr")))
                    .Where(i => !BranchNameParser.HasPrLabel(i.Issue.Labels))
                    .ToList();
                _openIssues = issuesWithMeta
                    .Where(i => i.Issue.Status == BeadsIssueStatus.Open)
                    .ToList();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to load beads issues for project {ProjectId}", Id);
                _openIssues = [];
                _inProgressIssues = [];
            }
        }
    }

    private List<FlattenedPR> FlattenPRs(List<PullRequest> prs, int level = 0)
    {
        var result = new List<FlattenedPR>();
        foreach (var pr in prs.OrderBy(p => p.CreatedAt))
        {
            result.Add(new FlattenedPR(pr, level));
            if (pr.Children.Any())
            {
                result.AddRange(FlattenPRs(pr.Children.ToList(), level + 1));
            }
        }

        return result;
    }

    private async Task LoadPastPRsAsync()
    {
        Logger.LogInformation("LoadPastPRsAsync started for project {ProjectId}", Id);
        
        if (_project == null)
        {
            Logger.LogWarning("LoadPastPRsAsync: _project is null, returning early");
            return;
        }

        var isConfigured = await GitHubService.IsConfiguredAsync(_project.Id);
        Logger.LogInformation("LoadPastPRsAsync: GitHub configured = {IsConfigured}", isConfigured);
        if (!isConfigured)
            return;

        _isLoadingPastPRs = true;
        StateHasChanged();

        try
        {
            Logger.LogInformation("LoadPastPRsAsync: Fetching merged PRs...");
            var mergedPRs = await PullRequestWorkflowService.GetMergedPullRequestsWithTimeAsync(Id);
            Logger.LogInformation("LoadPastPRsAsync: Got {Count} merged PRs", mergedPRs.Count);
            
            Logger.LogInformation("LoadPastPRsAsync: Fetching closed PRs...");
            var closedPRs = await PullRequestWorkflowService.GetClosedPullRequestsWithTimeAsync(Id);
            Logger.LogInformation("LoadPastPRsAsync: Got {Count} closed PRs", closedPRs.Count);
            
            _pastPRs = mergedPRs.Concat(closedPRs).ToList();
            Logger.LogInformation("LoadPastPRsAsync: Total past PRs = {Count}", _pastPRs.Count);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load past PRs for project {ProjectId}", Id);
            _pastPRs = [];
        }
        finally
        {
            _isLoadingPastPRs = false;
            StateHasChanged();
        }
    }

    private void LoadMorePastPRs()
    {
        _pastPRsDisplayCount += 5;
    }

    private async Task SyncPullRequestsAsync()
    {
        if (_project == null || _isSyncingPRs)
            return;

        var hasGitHubConfig = !string.IsNullOrEmpty(_project.GitHubOwner) &&
                              !string.IsNullOrEmpty(_project.GitHubRepo);
        if (!hasGitHubConfig)
            return;

        var isConfigured = await GitHubService.IsConfiguredAsync(_project.Id);
        if (!isConfigured)
        {
            _tokenMissing = true;
            Logger.LogWarning("PR sync skipped for project {ProjectId}: GITHUB_TOKEN not configured", _project.Id);
            StateHasChanged();
            return;
        }

        _isSyncingPRs = true;
        _tokenMissing = false;
        _syncError = null;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Starting automatic PR sync for project {ProjectId} ({Owner}/{Repo})",
                _project.Id, _project.GitHubOwner, _project.GitHubRepo);

            _lastSyncResult = await GitHubService.SyncPullRequestsAsync(_project.Id);

            if (_lastSyncResult.Errors.Count > 0)
            {
                _syncError = string.Join("; ", _lastSyncResult.Errors);
                Logger.LogWarning("PR sync completed with errors for project {ProjectId}: {Errors}",
                    _project.Id, _syncError);
            }
            else
            {
                Logger.LogInformation("PR sync completed for project {ProjectId}: {Imported} imported, {Updated} updated, {Removed} removed",
                    _project.Id, _lastSyncResult.Imported, _lastSyncResult.Updated, _lastSyncResult.Removed);
            }

            await LoadData();
        }
        catch (Exception ex)
        {
            _syncError = ex.Message;
            Logger.LogError(ex, "Failed to sync pull requests for project {ProjectId}", _project.Id);
        }
        finally
        {
            _isSyncingPRs = false;
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
        if (_selectedPullRequestId != null)
        {
            _selectedPullRequest = await PullRequestDataService.GetByIdAsync(_selectedPullRequestId);
        }
    }

    private async Task SelectPullRequest(string pullRequestId)
    {
        // Clear any beads issue selection
        _selectedBeadsIssueId = null;
        _selectedBeadsIssue = null;
        
        _selectedPullRequestId = pullRequestId;
        _selectedPullRequest = await PullRequestDataService.GetByIdAsync(pullRequestId);
    }

    private void SelectBeadsIssue(string issueId)
    {
        // Clear any pull request selection
        _selectedPullRequestId = null;
        _selectedPullRequest = null;
        
        _selectedBeadsIssueId = issueId;
        _selectedBeadsIssue = _openIssues?.FirstOrDefault(i => i.Issue.Id == issueId)
                           ?? _inProgressIssues?.FirstOrDefault(i => i.Issue.Id == issueId);
    }

    private void ClearSelection()
    {
        _selectedPullRequestId = null;
        _selectedPullRequest = null;
        _selectedBeadsIssueId = null;
        _selectedBeadsIssue = null;
    }

    private int GetTotalCurrentPRCount()
    {
        return _flattenedCurrentPRs.Count;
    }

    private int GetTotalCurrentCount()
    {
        return _flattenedCurrentPRs.Count + (_inProgressIssues?.Count ?? 0);
    }

    private static string GetPastPRStatusColor(PullRequestStatus status) => status switch
    {
        PullRequestStatus.Merged => "status-merged",
        PullRequestStatus.Closed => "status-closed",
        _ => "status-default"
    };

    private static string GetCurrentPRStatusColor(OpenPullRequestStatus status) => status switch
    {
        OpenPullRequestStatus.InDevelopment => "status-in-development",
        OpenPullRequestStatus.ReadyForReview => "status-ready-for-review",
        OpenPullRequestStatus.HasReviewComments => "status-has-review-comments",
        OpenPullRequestStatus.Approved => "status-approved",
        _ => "status-default"
    };

    private static string GetBeadsIssueTypeStatusColor(BeadsIssueType type) => type switch
    {
        BeadsIssueType.Feature => "status-feature",
        BeadsIssueType.Bug => "status-bug",
        BeadsIssueType.Chore => "status-chore",
        BeadsIssueType.Task => "status-task",
        BeadsIssueType.Epic => "status-epic",
        _ => "status-default"
    };

    private static string GetBeadsIssueStatusColor(BeadsIssue issue)
    {
        // If in progress or awaiting PR, show working status; otherwise show type-based color
        if (issue.Status == BeadsIssueStatus.InProgress)
            return "status-in-development";
        if (issue.Status == BeadsIssueStatus.Blocked && issue.Labels.Contains("awaiting-pr"))
            return "status-ready-for-review";
        if (issue.Status == BeadsIssueStatus.Closed)
            return "status-approved";
        return GetBeadsIssueTypeStatusColor(issue.Type);
    }

    private static string GetBeadsIssueStatusTooltip(BeadsIssue issue)
    {
        if (issue.Status == BeadsIssueStatus.Blocked && issue.Labels.Contains("awaiting-pr"))
            return $"{issue.Type} (Awaiting PR)";
        return $"{issue.Type} ({issue.Status})";
    }

    private static string? GetPastPRSubtitle(PullRequestInfo pr)
    {
        var parts = new List<string>();

        if (pr.MergedAt.HasValue)
            parts.Add($"Merged {pr.MergedAt.Value:MMM d, yyyy}");
        else if (pr.ClosedAt.HasValue)
            parts.Add($"Closed {pr.ClosedAt.Value:MMM d, yyyy}");

        if (!string.IsNullOrEmpty(pr.Group))
            parts.Add(pr.Group);

        return parts.Count > 0 ? string.Join(" - ", parts) : null;
    }

    private static string? GetCurrentPRSubtitle(PullRequest pr)
    {
        var parts = new List<string>();

        if (!string.IsNullOrEmpty(pr.BranchName))
            parts.Add(pr.BranchName);

        return parts.Count > 0 ? string.Join(" - ", parts) : null;
    }

    private static string? GetBeadsIssueSubtitle(BeadsIssueWithMetadata issueWithMeta)
    {
        var parts = new List<string>();

        // Parse group from hsp: label
        var branchInfo = BeadsBranchLabel.Parse(issueWithMeta.Issue.Labels);
        if (branchInfo != null)
            parts.Add(branchInfo.Value.Group);

        if (!string.IsNullOrEmpty(issueWithMeta.Issue.Description))
        {
            // Truncate description for subtitle display
            var desc = issueWithMeta.Issue.Description;
            if (desc.Length > 60)
                desc = desc[..57] + "...";
            parts.Add(desc);
        }

        return parts.Count > 0 ? string.Join(" - ", parts) : null;
    }

    private async Task StartTestAgent()
    {
        if (_project == null || TestAgentService == null) return;
        
        _isTestAgentLoading = true;
        _testAgentError = null;
        _verificationResult = null;
        StateHasChanged();

        try
        {
            var result = await TestAgentService.StartTestAgentAsync(_project.Id);
            if (result.Success)
            {
                _testAgentStatus = TestAgentService.GetTestAgentStatus(_project.Id);
            }
            else
            {
                _testAgentError = result.Error;
            }
        }
        catch (Exception ex)
        {
            _testAgentError = ex.Message;
        }
        finally
        {
            _isTestAgentLoading = false;
        }
    }

    private async Task StopTestAgent()
    {
        if (_project == null || TestAgentService == null) return;
        
        _isTestAgentLoading = true;
        _testAgentError = null;
        _verificationResult = null;
        StateHasChanged();

        try
        {
            await TestAgentService.StopTestAgentAsync(_project.Id);
            _testAgentStatus = null;
        }
        catch (Exception ex)
        {
            _testAgentError = ex.Message;
        }
        finally
        {
            _isTestAgentLoading = false;
        }
    }

    private async Task VerifySession()
    {
        if (_project == null || TestAgentService == null) return;
        
        _isVerifying = true;
        StateHasChanged();

        try
        {
            _verificationResult = await TestAgentService.VerifySessionVisibilityAsync(_project.Id);
        }
        catch (Exception ex)
        {
            _verificationResult = new SessionVerificationResult
            {
                SessionFound = false,
                Error = ex.Message
            };
        }
        finally
        {
            _isVerifying = false;
        }
    }

}

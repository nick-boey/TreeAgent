@using Homespun.Features.PullRequests.Data.Entities
<div class="pull-request-node" style="padding-left: @(Level * 20)px">
    <div class="pull-request-item @(IsSelected ? "selected" : "") @GetStatusClass()"
         @onclick="HandleClick">
        @if (PullRequest.Children.Any())
        {
            <span class="tree-toggle" @onclick="ToggleExpand" @onclick:stopPropagation="true">
                @(IsExpanded ? "[-]" : "[+]")
            </span>
        }
        else
        {
            <span class="tree-toggle-spacer">&nbsp;&nbsp;&nbsp;</span>
        }
        <span class="status-indicator @GetStatusClass()"></span>
        <span class="pull-request-title">@PullRequest.Title</span>
        @if (PullRequest.GitHubPRNumber.HasValue)
        {
            <span class="badge bg-secondary ms-2">#@PullRequest.GitHubPRNumber</span>
        }
    </div>
    @if (IsExpanded && PullRequest.Children.Any())
    {
        <div class="pull-request-children">
            @foreach (var child in PullRequest.Children.OrderBy(c => c.CreatedAt))
            {
                <FeatureNode PullRequest="child"
                             SelectedPullRequestId="@SelectedPullRequestId"
                             OnPullRequestSelected="OnPullRequestSelected"
                             Level="Level + 1" />
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public PullRequest PullRequest { get; set; } = null!;

    [Parameter]
    public string? SelectedPullRequestId { get; set; }

    [Parameter]
    public EventCallback<string> OnPullRequestSelected { get; set; }

    [Parameter]
    public int Level { get; set; }

    private bool IsExpanded { get; set; } = true;
    private bool IsSelected => SelectedPullRequestId == PullRequest.Id;

    private void ToggleExpand()
    {
        IsExpanded = !IsExpanded;
    }

    private async Task HandleClick()
    {
        await OnPullRequestSelected.InvokeAsync(PullRequest.Id);
    }

    private string GetStatusClass()
    {
        return PullRequest.Status switch
        {
            OpenPullRequestStatus.InDevelopment => "status-in-development",
            OpenPullRequestStatus.ReadyForReview => "status-ready-for-review",
            _ => ""
        };
    }
}

@using Homespun.Features.Beads
@using Homespun.Features.Beads.Data
@using Homespun.Features.Beads.Services
@using Homespun.Features.ClaudeCode.Data
@using Homespun.Features.ClaudeCode.Services
@using Homespun.Features.Git
@using Homespun.Features.Projects
@using Homespun.Features.PullRequests.Data.Entities

@inject IClaudeSessionStore SessionStore
@inject IClaudeSessionService SessionService
@inject IAgentStartupTracker StartupTracker
@inject IBeadsDatabaseService BeadsDatabaseService
@inject IGitWorktreeService GitWorktreeService
@inject ProjectService ProjectService
@inject NavigationManager NavigationManager
@inject ILogger<BeadsIssueDetailPanel> Logger

<div class="card beads-issue-detail-panel">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Issue Details</span>
        <div class="d-flex gap-1">
            <a href="projects/@ProjectId/issues/@Issue.Id/edit" class="btn btn-sm btn-outline-secondary" title="Edit issue">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                </svg>
            </a>
            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="HandleClose" title="Close panel">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="card-body">
            <h5 class="card-title">@Issue.Title</h5>

            <div class="mb-3">
                <span class="badge bg-secondary">@Issue.Id</span>
                <span class="badge @GetTypeBadgeClass() ms-1">@Issue.Type</span>
                <span class="badge @GetStatusBadgeClass() ms-1">@GetStatusDisplay()</span>
                @if (Issue.Priority.HasValue)
                {
                    <span class="badge @GetPriorityBadgeClass() ms-1">P@Issue.Priority</span>
                }
                @if (StartupTracker.IsStarting(Issue.Id))
                {
                    <span class="badge bg-warning text-dark ms-1">
                        <span class="spinner-border spinner-border-sm me-1" role="status" style="width: 0.6rem; height: 0.6rem;"></span>
                        Starting...
                    </span>
                }
                else if (_session != null)
                {
                    <span class="badge bg-success ms-1">Session Active</span>
                }
            </div>

            @if (!string.IsNullOrEmpty(Issue.Description))
            {
                <div class="description-content mb-3">
                    <pre class="mb-0">@Issue.Description</pre>
                </div>
            }

            <dl class="row small">
                @if (Metadata != null && !string.IsNullOrEmpty(Metadata.BranchName))
                {
                    <dt class="col-4">Branch</dt>
                    <dd class="col-8"><code>@Metadata.BranchName</code></dd>
                }
                else if (_branchInfo != null)
                {
                    <dt class="col-4">Branch Preview</dt>
                    <dd class="col-8"><code>@GetBranchPreview()</code></dd>
                }

                @if (_branchInfo != null)
                {
                    <dt class="col-4">Group</dt>
                    <dd class="col-8">@_branchInfo.Value.Group</dd>

                    <dt class="col-4">Branch ID</dt>
                    <dd class="col-8">@_branchInfo.Value.BranchId</dd>
                }

                @if (Issue.Labels.Count > 0)
                {
                    <dt class="col-4">Labels</dt>
                    <dd class="col-8">
                        @foreach (var label in Issue.Labels.Where(l => !BeadsBranchLabel.IsHomespunLabel(l)))
                        {
                            <span class="badge bg-light text-dark me-1">@label</span>
                        }
                        @if (_branchInfo != null)
                        {
                            <span class="badge bg-info text-dark me-1" title="Homespun branch label">@GetHspLabel()</span>
                        }
                    </dd>
                }

                @if (!string.IsNullOrEmpty(Issue.ParentId))
                {
                    <dt class="col-4">Parent</dt>
                    <dd class="col-8"><code>@Issue.ParentId</code></dd>
                }

                @if (!string.IsNullOrEmpty(Issue.Assignee))
                {
                    <dt class="col-4">Assignee</dt>
                    <dd class="col-8">@Issue.Assignee</dd>
                }
            </dl>

            @* Warning if no hsp: label *@
            @if (_branchInfo == null)
            {
                <div class="alert alert-warning py-2 small">
                    <strong>Missing branch label:</strong> This issue needs an <code>hsp:</code> label to start development.
                    <a href="projects/@ProjectId/issues/@Issue.Id/edit" class="btn btn-sm btn-link p-0 ms-1">Add one now</a>
                </div>
            }

            @* Session Status Display *@
            @if (_session != null)
            {
                <div class="border-top pt-3 mt-3">
                    <h6>Claude Code Session</h6>
                    <div class="mb-2">
                        <span class="badge @GetSessionStatusBadgeClass()">@_session.Status</span>
                        <a href="/session/@_session.Id" class="btn btn-sm btn-outline-primary ms-2">
                            Open Chat
                        </a>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">
                            Mode: <code>@_session.Mode</code>
                        </small>
                        <br/>
                        <small class="text-muted">
                            Model: <code>@_session.Model</code>
                        </small>
                    </div>
                </div>
            }
        </div>
        <div class="card-footer">
            @if (_branchInfo != null && _session == null && !StartupTracker.IsStarting(Issue.Id))
            {
                <div class="mb-2">
                    <label class="form-label small mb-1">Model</label>
                    <ModelSelector Id="@($"beads-model-{Issue.Id}")"
                                   SelectedModel="@_selectedModel"
                                   SelectedModelChanged="@(m => _selectedModel = m)" />
                </div>
            }

            <div class="d-flex flex-wrap gap-2">
                @if (StartupTracker.IsStarting(Issue.Id))
                {
                    <button class="btn btn-sm btn-secondary" disabled>
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        Starting Session...
                    </button>
                }
                else if (_session != null)
                {
                    <a href="/session/@_session.Id" class="btn btn-sm btn-primary">
                        Open Chat
                    </a>
                    <button class="btn btn-sm btn-outline-danger" @onclick="StopSession" disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        }
                        Stop Session
                    </button>
                }
                else if (Issue.Status == BeadsIssueStatus.Open && _branchInfo != null)
                {
                    <button class="btn btn-sm btn-outline-primary" @onclick="StartPlanning" title="Start a read-only planning session">
                        Start Planning
                    </button>
                    <button class="btn btn-sm btn-success" @onclick="StartBuilding" title="Start a session with full code editing">
                        Start Building
                    </button>
                }
                else if (Issue.Status == BeadsIssueStatus.Open && _branchInfo == null)
                {
                    <button class="btn btn-sm btn-secondary" disabled title="Add an hsp: label to enable development">
                        Start Development
                    </button>
                }
                else if ((Issue.Status == BeadsIssueStatus.InProgress ||
                         (Issue.Status == BeadsIssueStatus.Blocked && Issue.Labels.Contains("awaiting-pr")))
                         && _session == null && _branchInfo != null)
                {
                    <button class="btn btn-sm btn-success" @onclick="StartBuilding">
                        Resume Building
                    </button>
                }

                @if (Issue.Status == BeadsIssueStatus.Open || Issue.Status == BeadsIssueStatus.InProgress || Issue.Status == BeadsIssueStatus.Blocked || Issue.Status == BeadsIssueStatus.Deferred)
                {
                    <button class="btn btn-sm btn-outline-primary" @onclick="CloseIssue" disabled="@_isLoading" title="Mark issue as completed">
                        Close Issue
                    </button>
                }

                <button class="btn btn-sm btn-outline-danger" @onclick="ShowDeleteConfirmation" disabled="@_isLoading" title="Delete issue permanently">
                    Delete
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger mt-2 mb-0 py-1 px-2 small">@_errorMessage</div>
            }
        </div>

        @if (_showDeleteConfirmation)
        {
            <div class="modal-backdrop fade show" style="background-color: rgba(0,0,0,0.5);"></div>
            <div class="modal fade show d-block" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Delete Issue</h5>
                            <button type="button" class="btn-close" @onclick="HideDeleteConfirmation"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete issue <strong>@Issue.Id</strong>?</p>
                            <p class="mb-0">This action will mark the issue as tombstone and cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="HideDeleteConfirmation">Cancel</button>
                            <button type="button" class="btn btn-danger" @onclick="DeleteIssue" disabled="@_isLoading">
                                @if (_isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                Delete Issue
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
</div>

<style>
    .description-content pre {
        background-color: var(--bg-secondary);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.85rem;
        max-height: 200px;
        overflow-y: auto;
    }
</style>

@code {
    [Parameter] public required string ProjectId { get; set; }

    [Parameter] public required BeadsIssue Issue { get; set; }

    [Parameter] public BeadsIssueMetadata? Metadata { get; set; }

    [Parameter] public EventCallback OnActionCompleted { get; set; }

    [Parameter] public EventCallback OnClose { get; set; }

    private bool _isLoading;
    private bool _showDeleteConfirmation;
    private string? _errorMessage;
    private ClaudeSession? _session;
    private (string Group, string BranchId)? _branchInfo;
    private Project? _project;
    private string _selectedModel = "sonnet";

    protected override async Task OnInitializedAsync()
    {
        // Load project info
        _project = await ProjectService.GetByIdAsync(ProjectId);

        // Set default model from project if available
        if (_project?.DefaultModel != null)
        {
            _selectedModel = _project.DefaultModel;
        }
    }

    protected override void OnParametersSet()
    {
        _session = null;
        _errorMessage = null;

        // Parse group and branch ID from hsp: label
        _branchInfo = BeadsBranchLabel.Parse(Issue.Labels);

        // Check for existing session
        _session = SessionStore.GetByEntityId(Issue.Id);
    }

    private void HandleClose()
    {
        OnClose.InvokeAsync();
    }

    private string GetBranchPreview()
    {
        if (_branchInfo == null) return "";
        return $"{_branchInfo.Value.Group}/{Issue.Type.ToString().ToLowerInvariant()}/{_branchInfo.Value.BranchId}+{Issue.Id}";
    }

    private string GetHspLabel()
    {
        if (_branchInfo == null) return "";
        return BeadsBranchLabel.Create(_branchInfo.Value.Group, _branchInfo.Value.BranchId);
    }

    private async Task StartPlanning()
    {
        await StartSession(SessionMode.Plan);
    }

    private async Task StartBuilding()
    {
        await StartSession(SessionMode.Build);
    }

    private async Task StartSession(SessionMode mode)
    {
        if (_project == null)
        {
            _errorMessage = "Project not available.";
            return;
        }

        if (_branchInfo == null)
        {
            _errorMessage = "Issue must have branch information (hsp: label) before starting an agent.";
            return;
        }

        StartupTracker.MarkAsStarting(Issue.Id);
        _errorMessage = null;

        try
        {
            // Create worktree for the issue's branch
            var branchName = GetBranchPreview();
            Logger.LogInformation("Creating worktree for branch {BranchName} from {ProjectPath}", branchName, _project.LocalPath);

            var worktreePath = await GitWorktreeService.CreateWorktreeAsync(
                _project.LocalPath,
                branchName,
                createBranch: true,
                baseBranch: _project.DefaultBranch);

            if (string.IsNullOrEmpty(worktreePath))
            {
                _errorMessage = "Failed to create worktree for issue branch.";
                StartupTracker.MarkAsFailed(Issue.Id, _errorMessage);
                return;
            }

            Logger.LogInformation("Created worktree at {WorktreePath} for issue {IssueId}", worktreePath, Issue.Id);

            var systemPrompt = GenerateSystemPrompt();
            _session = await SessionService.StartSessionAsync(
                Issue.Id,
                ProjectId,
                worktreePath,
                mode,
                _selectedModel,
                systemPrompt);

            StartupTracker.MarkAsStarted(Issue.Id);

            // Navigate to the session chat page
            NavigationManager.NavigateTo($"/session/{_session.Id}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to start session for issue {IssueId}", Issue.Id);
            StartupTracker.MarkAsFailed(Issue.Id, ex.Message);
            _errorMessage = $"Failed to start session: {ex.Message}";
            _session = null;
        }
    }

    private string? GenerateSystemPrompt()
    {
        // Build a context-aware system prompt based on the issue
        var sb = new System.Text.StringBuilder();
        sb.AppendLine($"You are working on issue {Issue.Id}: {Issue.Title}");

        if (!string.IsNullOrEmpty(Issue.Description))
        {
            sb.AppendLine();
            sb.AppendLine("Issue Description:");
            sb.AppendLine(Issue.Description);
        }

        if (_branchInfo != null)
        {
            sb.AppendLine();
            sb.AppendLine($"Branch: {GetBranchPreview()}");
        }

        return sb.ToString();
    }

    private async Task StopSession()
    {
        if (_session == null) return;

        _isLoading = true;
        _errorMessage = null;
        try
        {
            await SessionService.StopSessionAsync(_session.Id);
            _session = null;
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task CloseIssue()
    {
        if (_project?.LocalPath == null)
        {
            _errorMessage = "Project path not available.";
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        try
        {
            var success = await BeadsDatabaseService.CloseIssueAsync(_project?.LocalPath, Issue.Id);

            if (!success)
            {
                _errorMessage = "Failed to close issue.";
                return;
            }
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to close issue: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ShowDeleteConfirmation()
    {
        _showDeleteConfirmation = true;
    }

    private void HideDeleteConfirmation()
    {
        _showDeleteConfirmation = false;
    }

    private async Task DeleteIssue()
    {
        if (_project?.LocalPath == null)
        {
            _errorMessage = "Project path not available.";
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        try
        {
            var success = await BeadsDatabaseService.DeleteIssueAsync(_project?.LocalPath, Issue.Id);

            if (!success)
            {
                _errorMessage = "Failed to delete issue.";
                _showDeleteConfirmation = false;
                return;
            }
            _showDeleteConfirmation = false;
            await OnActionCompleted.InvokeAsync();
            await OnClose.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to delete issue: {ex.Message}";
            _showDeleteConfirmation = false;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetStatusDisplay()
    {
        if (Issue.Status == BeadsIssueStatus.Blocked && Issue.Labels.Contains("awaiting-pr"))
            return "Awaiting PR";
        return Issue.Status.ToString();
    }

    private string GetTypeBadgeClass() => Issue.Type switch
    {
        BeadsIssueType.Feature => "bg-primary",
        BeadsIssueType.Bug => "bg-danger",
        BeadsIssueType.Task => "bg-info",
        BeadsIssueType.Epic => "bg-purple",
        BeadsIssueType.Chore => "bg-dark",
        _ => "bg-secondary"
    };

    private string GetStatusBadgeClass() => Issue.Status switch
    {
        BeadsIssueStatus.Open => "bg-secondary",
        BeadsIssueStatus.InProgress => "bg-primary",
        BeadsIssueStatus.Blocked => Issue.Labels.Contains("awaiting-pr") ? "bg-info" : "bg-warning text-dark",
        BeadsIssueStatus.Closed => "bg-success",
        BeadsIssueStatus.Deferred => "bg-light text-dark",
        _ => "bg-secondary"
    };

    private string GetPriorityBadgeClass() => Issue.Priority switch
    {
        0 => "bg-danger",
        1 => "bg-warning text-dark",
        2 => "bg-info",
        3 => "bg-secondary",
        4 => "bg-light text-dark",
        _ => "bg-secondary"
    };

    private string GetSessionStatusBadgeClass() => _session?.Status switch
    {
        ClaudeSessionStatus.Running => "bg-success",
        ClaudeSessionStatus.Processing => "bg-primary",
        ClaudeSessionStatus.WaitingForInput => "bg-info",
        ClaudeSessionStatus.Starting => "bg-warning text-dark",
        ClaudeSessionStatus.Stopped => "bg-secondary",
        ClaudeSessionStatus.Error => "bg-danger",
        _ => "bg-secondary"
    };
}

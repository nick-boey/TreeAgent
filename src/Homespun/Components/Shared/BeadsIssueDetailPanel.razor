@using Homespun.Features.Beads
@using Homespun.Features.Beads.Data
@using Homespun.Features.Beads.Services
@using Homespun.Features.Agents.Abstractions
@using Homespun.Features.Agents.Services
@using Homespun.Features.OpenCode.Services
@using Homespun.Features.Projects

@inject IAgentHarnessFactory HarnessFactory
@inject IAgentWorkflowService AgentWorkflowService
@inject IAgentStartupTracker StartupTracker
@inject IBeadsDatabaseService BeadsDatabaseService
@inject ProjectService ProjectService
@inject NavigationManager NavigationManager

<div class="card beads-issue-detail-panel" @onkeydown="HandleKeyDown" tabindex="0">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Issue Details</span>
        <div class="d-flex gap-1">
            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="NavigateToEdit" title="Edit issue">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                </svg>
            </button>
            <button type="button" class="btn-close" @onclick="HandleClose"></button>
        </div>
    </div>
    
    @* View Mode *@
        <div class="card-body">
            <h5 class="card-title">@Issue.Title</h5>

            <div class="mb-3">
                <span class="badge bg-secondary">@Issue.Id</span>
                <span class="badge @GetTypeBadgeClass() ms-1">@Issue.Type</span>
                <span class="badge @GetStatusBadgeClass() ms-1">@GetStatusDisplay()</span>
                @if (Issue.Priority.HasValue)
                {
                    <span class="badge @GetPriorityBadgeClass() ms-1">P@Issue.Priority</span>
                }
                @if (StartupTracker.IsStarting(Issue.Id))
                {
                    <span class="badge bg-warning text-dark ms-1">
                        <span class="spinner-border spinner-border-sm me-1" role="status" style="width: 0.6rem; height: 0.6rem;"></span>
                        Starting...
                    </span>
                }
                else if (_agentStatus != null)
                {
                    <span class="badge bg-success ms-1">Agent Running</span>
                }
            </div>

            @if (!string.IsNullOrEmpty(Issue.Description))
            {
                <div class="description-content mb-3">
                    <pre class="mb-0">@Issue.Description</pre>
                </div>
            }

            <dl class="row small">
                @if (Metadata != null && !string.IsNullOrEmpty(Metadata.BranchName))
                {
                    <dt class="col-4">Branch</dt>
                    <dd class="col-8"><code>@Metadata.BranchName</code></dd>
                }
                else if (_branchInfo != null)
                {
                    <dt class="col-4">Branch Preview</dt>
                    <dd class="col-8"><code>@GetBranchPreview()</code></dd>
                }
                
                @if (_branchInfo != null)
                {
                    <dt class="col-4">Group</dt>
                    <dd class="col-8">@_branchInfo.Value.Group</dd>
                    
                    <dt class="col-4">Branch ID</dt>
                    <dd class="col-8">@_branchInfo.Value.BranchId</dd>
                }
                
                @if (Issue.Labels.Count > 0)
                {
                    <dt class="col-4">Labels</dt>
                    <dd class="col-8">
                        @foreach (var label in Issue.Labels.Where(l => !BeadsBranchLabel.IsHomespunLabel(l)))
                        {
                            <span class="badge bg-light text-dark me-1">@label</span>
                        }
                        @if (_branchInfo != null)
                        {
                            <span class="badge bg-info text-dark me-1" title="Homespun branch label">@GetHspLabel()</span>
                        }
                    </dd>
                }
                
                @if (!string.IsNullOrEmpty(Issue.ParentId))
                {
                    <dt class="col-4">Parent</dt>
                    <dd class="col-8"><code>@Issue.ParentId</code></dd>
                }
                
                @if (!string.IsNullOrEmpty(Issue.Assignee))
                {
                    <dt class="col-4">Assignee</dt>
                    <dd class="col-8">@Issue.Assignee</dd>
                }
            </dl>

            @* Warning if no hsp: label *@
            @if (_branchInfo == null)
            {
                <div class="alert alert-warning py-2 small">
                    <strong>Missing branch label:</strong> This issue needs an <code>hsp:</code> label to start development.
                    <button class="btn btn-sm btn-link p-0 ms-1" @onclick="NavigateToEdit">Add one now</button>
                </div>
            }

            @* Agent Status Display *@
            @if (_agentStatus != null)
            {
                <div class="border-top pt-3 mt-3">
                    <h6>Agent (@_agentStatus.HarnessType)</h6>
                    <div class="mb-2">
                        <span class="badge bg-success">Running</span>
                        @if (_agentStatus.Agent.WebViewUrl != null)
                        {
                            <a href="@_agentStatus.Agent.WebViewUrl" target="_blank"
                               class="btn btn-sm btn-outline-primary ms-2">
                                Open Web View
                            </a>
                        }
                        else
                        {
                            <span class="text-muted ms-2">Session initializing...</span>
                        }
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">
                            Harness: <code>@_agentStatus.HarnessType</code>
                        </small>
                        @if (!string.IsNullOrEmpty(_agentStatus.Agent.ActiveSessionId))
                        {
                            <br/>
                            <small class="text-muted">
                                Session: <code>@_agentStatus.Agent.ActiveSessionId</code>
                            </small>
                        }
                    </div>
                </div>
            }
        </div>
        <div class="card-footer">
            @if (_branchInfo != null && _agentStatus == null && !StartupTracker.IsStarting(Issue.Id))
            {
                <div class="mb-2 d-flex gap-3">
                    <div>
                        <label class="form-label small mb-1">Harness</label>
                        <HarnessSelector Id="@($"beads-harness-{Issue.Id}")"
                                         SelectedHarness="@_selectedHarness"
                                         SelectedHarnessChanged="@(h => _selectedHarness = h)" />
                    </div>
                    <div>
                        <label class="form-label small mb-1">Model</label>
                        <ModelSelector Id="@($"beads-model-{Issue.Id}")"
                                       SelectedModel="@_selectedModel"
                                       SelectedModelChanged="@(m => _selectedModel = m)" />
                    </div>
                </div>
            }

            <div class="d-flex flex-wrap gap-2">
                @if (StartupTracker.IsStarting(Issue.Id))
                {
                    <button class="btn btn-sm btn-secondary" disabled>
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        Starting Agent...
                    </button>
                }
                else if (_agentStatus != null)
                {
                    <button class="btn btn-sm btn-outline-danger" @onclick="StopAgent" disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        }
                        Stop Agent
                    </button>
                }
                else if (Issue.Status == BeadsIssueStatus.Open && _branchInfo != null)
                {
                    <button class="btn btn-sm btn-outline-primary" @onclick="StartPlanning">
                        Start Planning
                    </button>
                    <button class="btn btn-sm btn-success" @onclick="StartBuilding">
                        Start Building
                    </button>
                }
                else if (Issue.Status == BeadsIssueStatus.Open && _branchInfo == null)
                {
                    <button class="btn btn-sm btn-secondary" disabled title="Add an hsp: label to enable development">
                        Start Development
                    </button>
                }
                else if ((Issue.Status == BeadsIssueStatus.InProgress ||
                         (Issue.Status == BeadsIssueStatus.Blocked && Issue.Labels.Contains("awaiting-pr")))
                         && _agentStatus == null && _branchInfo != null)
                {
                    <button class="btn btn-sm btn-success" @onclick="ResumeAgent">
                        Resume Agent
                    </button>
                }
                
                @if (Issue.Status == BeadsIssueStatus.Open || Issue.Status == BeadsIssueStatus.InProgress || Issue.Status == BeadsIssueStatus.Blocked || Issue.Status == BeadsIssueStatus.Deferred)
                {
                    <button class="btn btn-sm btn-outline-primary" @onclick="CloseIssue" disabled="@_isLoading" title="Mark issue as completed">
                        Close Issue
                    </button>
                }
                
                <button class="btn btn-sm btn-outline-danger" @onclick="ShowDeleteConfirmation" disabled="@_isLoading" title="Delete issue permanently">
                    Delete
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger mt-2 mb-0 py-1 px-2 small">@_errorMessage</div>
            }
        </div>
        
        @if (_showDeleteConfirmation)
        {
            <div class="modal-backdrop fade show" style="background-color: rgba(0,0,0,0.5);"></div>
            <div class="modal fade show d-block" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Delete Issue</h5>
                            <button type="button" class="btn-close" @onclick="HideDeleteConfirmation"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete issue <strong>@Issue.Id</strong>?</p>
                            <p class="mb-0">This action will mark the issue as tombstone and cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="HideDeleteConfirmation">Cancel</button>
                            <button type="button" class="btn btn-danger" @onclick="DeleteIssue" disabled="@_isLoading">
                                @if (_isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                Delete Issue
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
</div>

<style>
    .beads-issue-detail-panel:focus {
        outline: none;
    }

    .description-content pre {
        background-color: var(--bg-secondary);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.85rem;
        max-height: 200px;
        overflow-y: auto;
    }
</style>

@code {
    [Parameter] public required string ProjectId { get; set; }
    
    [Parameter] public required BeadsIssue Issue { get; set; }
    
    [Parameter] public BeadsIssueMetadata? Metadata { get; set; }

    [Parameter] public EventCallback OnActionCompleted { get; set; }

    [Parameter] public EventCallback OnClose { get; set; }

    private bool _isLoading;
    private bool _showDeleteConfirmation;
    private string? _errorMessage;
    private WorkflowAgentStatus? _agentStatus;
    private (string Group, string BranchId)? _branchInfo;
    private string? _projectLocalPath;
    private string _selectedModel = "anthropic/claude-opus-4";
    private string _selectedHarness = "";

    protected override async Task OnInitializedAsync()
    {
        // Initialize default harness
        _selectedHarness = HarnessFactory.DefaultHarnessType;

        // Load project info for local path
        var project = await ProjectService.GetByIdAsync(ProjectId);
        _projectLocalPath = project?.LocalPath;
    }

    protected override async Task OnParametersSetAsync()
    {
        _agentStatus = null;
        _errorMessage = null;

        // Parse group and branch ID from hsp: label
        _branchInfo = BeadsBranchLabel.Parse(Issue.Labels);

        // If the issue is in progress, there might be an agent running
        if (Issue.Status == BeadsIssueStatus.InProgress || Issue.Status == BeadsIssueStatus.Blocked)
        {
            await TryRefreshAgentStatus();
        }
    }

    private void NavigateToEdit()
    {
        NavigationManager.NavigateTo($"projects/{ProjectId}/issues/{Issue.Id}/edit");
    }

    private Task HandleKeyDown(KeyboardEventArgs e)
    {
        // No keyboard shortcuts in view mode
        return Task.CompletedTask;
    }

    private void HandleClose()
    {
        OnClose.InvokeAsync();
    }

    private string GetBranchPreview()
    {
        if (_branchInfo == null) return "";
        return $"{_branchInfo.Value.Group}/{Issue.Type.ToString().ToLowerInvariant()}/{_branchInfo.Value.BranchId}+{Issue.Id}";
    }

    private string GetHspLabel()
    {
        if (_branchInfo == null) return "";
        return BeadsBranchLabel.Create(_branchInfo.Value.Group, _branchInfo.Value.BranchId);
    }

    private async Task TryRefreshAgentStatus()
    {
        try
        {
            _agentStatus = await AgentWorkflowService.GetAgentStatusForBeadsIssueAsync(Issue.Id);
        }
        catch
        {
            _agentStatus = null;
        }
    }

    private void StartPlanning()
    {
        StartupTracker.MarkAsStarting(Issue.Id);
        _ = StartPlanningInBackgroundAsync();
    }

    private void StartBuilding()
    {
        StartupTracker.MarkAsStarting(Issue.Id);
        _ = StartBuildingInBackgroundAsync();
    }

    private void ResumeAgent()
    {
        StartupTracker.MarkAsStarting(Issue.Id);
        _ = StartAgentInBackgroundAsync();
    }

    private async Task StartPlanningInBackgroundAsync()
    {
        try
        {
            var status = await AgentWorkflowService.StartAgentForBeadsIssueAsync(
                ProjectId, Issue.Id, AgentMode.Planning, _selectedModel, _selectedHarness);
            StartupTracker.MarkAsStarted(Issue.Id);
            _agentStatus = status;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            StartupTracker.MarkAsFailed(Issue.Id, ex.Message);
            _errorMessage = ex.Message;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task StartBuildingInBackgroundAsync()
    {
        try
        {
            var status = await AgentWorkflowService.StartAgentForBeadsIssueAsync(
                ProjectId, Issue.Id, AgentMode.Building, _selectedModel, _selectedHarness);
            StartupTracker.MarkAsStarted(Issue.Id);
            _agentStatus = status;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            StartupTracker.MarkAsFailed(Issue.Id, ex.Message);
            _errorMessage = ex.Message;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task StartAgentInBackgroundAsync()
    {
        try
        {
            var status = await AgentWorkflowService.StartAgentForBeadsIssueAsync(
                ProjectId, Issue.Id, AgentMode.Building, _selectedModel, _selectedHarness);
            StartupTracker.MarkAsStarted(Issue.Id);
            _agentStatus = status;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            StartupTracker.MarkAsFailed(Issue.Id, ex.Message);
            _errorMessage = ex.Message;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task StopAgent()
    {
        if (_agentStatus == null) return;

        _isLoading = true;
        _errorMessage = null;
        try
        {
            await AgentWorkflowService.StopAgentAsync(Issue.Id);
            _agentStatus = null;
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task CloseIssue()
    {
        if (_projectLocalPath == null)
        {
            _errorMessage = "Project path not available.";
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        try
        {
            var success = await BeadsDatabaseService.CloseIssueAsync(_projectLocalPath, Issue.Id);

            if (!success)
            {
                _errorMessage = "Failed to close issue.";
                return;
            }
            // Note: bd sync is handled by the queue processor after debounce
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to close issue: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ShowDeleteConfirmation()
    {
        _showDeleteConfirmation = true;
    }

    private void HideDeleteConfirmation()
    {
        _showDeleteConfirmation = false;
    }

    private async Task DeleteIssue()
    {
        if (_projectLocalPath == null)
        {
            _errorMessage = "Project path not available.";
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        try
        {
            var success = await BeadsDatabaseService.DeleteIssueAsync(_projectLocalPath, Issue.Id);

            if (!success)
            {
                _errorMessage = "Failed to delete issue.";
                _showDeleteConfirmation = false;
                return;
            }
            // Note: bd sync is handled by the queue processor after debounce
            _showDeleteConfirmation = false;
            await OnActionCompleted.InvokeAsync();
            await OnClose.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to delete issue: {ex.Message}";
            _showDeleteConfirmation = false;
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private string GetStatusDisplay()
    {
        if (Issue.Status == BeadsIssueStatus.Blocked && Issue.Labels.Contains("awaiting-pr"))
            return "Awaiting PR";
        return Issue.Status.ToString();
    }

    private string GetTypeBadgeClass() => Issue.Type switch
    {
        BeadsIssueType.Feature => "bg-primary",
        BeadsIssueType.Bug => "bg-danger",
        BeadsIssueType.Task => "bg-info",
        BeadsIssueType.Epic => "bg-purple",
        BeadsIssueType.Chore => "bg-dark",
        _ => "bg-secondary"
    };

    private string GetStatusBadgeClass() => Issue.Status switch
    {
        BeadsIssueStatus.Open => "bg-secondary",
        BeadsIssueStatus.InProgress => "bg-primary",
        BeadsIssueStatus.Blocked => Issue.Labels.Contains("awaiting-pr") ? "bg-info" : "bg-warning text-dark",
        BeadsIssueStatus.Closed => "bg-success",
        BeadsIssueStatus.Deferred => "bg-light text-dark",
        _ => "bg-secondary"
    };

    private string GetPriorityBadgeClass() => Issue.Priority switch
    {
        0 => "bg-danger",
        1 => "bg-warning text-dark",
        2 => "bg-info",
        3 => "bg-secondary",
        4 => "bg-light text-dark",
        _ => "bg-secondary"
    };
}

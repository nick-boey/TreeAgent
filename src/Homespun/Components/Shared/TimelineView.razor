@using Homespun.Features.PullRequests
@using Homespun.Features.Roadmap
<div class="timeline-view">
    @* Past PRs (t < 0) *@
    @if (PastPRs.Any())
    {
        <div class="timeline-section past-section">
            <div class="section-header">
                <span class="section-icon">ðŸ“œ</span>
                <span class="section-title">Past</span>
                <span class="section-count">@PastPRs.Count</span>
            </div>
            <div class="section-items">
                @foreach (var pr in PastPRs.OrderByDescending(p => p.Time))
                {
                    <TimelineItem Item="pr.PullRequest"
                                  Time="pr.Time"
                                  IsSelected="@(SelectedId == pr.PullRequest.Number.ToString())"
                                  OnSelected="@(() => HandlePRSelected(pr.PullRequest.Number))" />
                }
            </div>
        </div>
    }

    @* Current PRs (t = 1) *@
    @if (CurrentPRs.Any())
    {
        <div class="timeline-section current-section">
            <div class="section-header">
                <span class="section-icon">ðŸ”„</span>
                <span class="section-title">Current</span>
                <span class="section-count">@CurrentPRs.Count</span>
            </div>
            <div class="section-items parallel-items">
                @foreach (var pr in CurrentPRs)
                {
                    <TimelineItem Item="pr.PullRequest"
                                  Status="pr.Status"
                                  Time="1"
                                  IsSelected="@(SelectedId == pr.PullRequest.Number.ToString())"
                                  OnSelected="@(() => HandlePRSelected(pr.PullRequest.Number))" />
                }
            </div>
        </div>
    }

    @* Future Changes (t > 1) *@
    @if (FutureChanges.Any())
    {
        <div class="timeline-section future-section">
            <div class="section-header">
                <span class="section-icon">ðŸ”®</span>
                <span class="section-title">Future</span>
                <span class="section-count">@FutureChanges.Count</span>
            </div>
            @if (GroupByComponent)
            {
                @foreach (var group in FutureChanges.GroupBy(c => c.Change.Group).OrderBy(g => g.Key))
                {
                    <div class="group-section">
                        <div class="group-header">
                            <span class="group-badge" style="background-color: @GetGroupColor(group.Key)">@group.Key</span>
                        </div>
                        <div class="section-items">
                            @foreach (var change in group.OrderBy(c => c.Depth).ThenBy(c => c.Change.Title))
                            {
                                <FutureChangeItem Change="change.Change"
                                                  Depth="change.Depth"
                                                  Time="change.Time"
                                                  IsSelected="@(SelectedId == change.Change.Id)"
                                                  OnSelected="@(() => HandleChangeSelected(change.Change.Id))" />
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="section-items">
                    @foreach (var change in FutureChanges.OrderBy(c => c.Time).ThenBy(c => c.Change.Title))
                    {
                        <FutureChangeItem Change="change.Change"
                                          Depth="change.Depth"
                                          Time="change.Time"
                                          IsSelected="@(SelectedId == change.Change.Id)"
                                          OnSelected="@(() => HandleChangeSelected(change.Change.Id))" />
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public List<PullRequestWithTime> PastPRs { get; set; } = [];

    [Parameter]
    public List<PullRequestWithStatus> CurrentPRs { get; set; } = [];

    [Parameter]
    public List<FutureChangeWithTime> FutureChanges { get; set; } = [];

    [Parameter]
    public string? SelectedId { get; set; }

    [Parameter]
    public bool GroupByComponent { get; set; } = true;

    [Parameter]
    public EventCallback<int> OnPRSelected { get; set; }

    [Parameter]
    public EventCallback<string> OnChangeSelected { get; set; }

    private static readonly Dictionary<string, string> GroupColors = new()
    {
        { "core", "#0d6efd" },
        { "web", "#198754" },
        { "api", "#6610f2" },
        { "services", "#fd7e14" },
        { "docs", "#20c997" },
        { "test", "#0dcaf0" }
    };

    private string GetGroupColor(string group)
    {
        return GroupColors.GetValueOrDefault(group.ToLower(), "#6c757d");
    }

    private async Task HandlePRSelected(int prNumber)
    {
        await OnPRSelected.InvokeAsync(prNumber);
    }

    private async Task HandleChangeSelected(string changeId)
    {
        await OnChangeSelected.InvokeAsync(changeId);
    }
}

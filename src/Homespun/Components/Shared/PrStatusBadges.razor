@using Homespun.Features.GitHub
@using Homespun.Features.PullRequests

@if (Status != null)
{
    <div class="pr-status-section border rounded p-2 @CssClass">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                    <path d="M7.177 11.396c.112.492.227.905.341 1.24a3.19 3.19 0 0 0-.337.247c-.385.334-.718.77-.987 1.284h-.107c-.269-.514-.602-.95-.987-1.284a3.19 3.19 0 0 0-.337-.247c.114-.335.229-.748.341-1.24.188-.835.293-1.843.293-2.896s-.105-2.06-.293-2.896c-.112-.492-.227-.905-.341-1.24a3.19 3.19 0 0 0 .337-.247c.385-.334.718-.77.987-1.284h.107c.269.514.602.95.987 1.284.148.128.308.242.477.341-.016.028-.031.057-.046.086l-.015.03c-.054.114-.087.233-.1.355a11.6 11.6 0 0 0-.063.77v.003c-.008.19-.014.379-.014.565 0 .239.008.474.023.702.015.213.04.42.077.617.035.19.083.374.145.543.062.169.135.32.218.447a1.72 1.72 0 0 0 .148.19l.143.149c.023.022.046.046.07.068.021.019.042.038.064.056l.023.02.024.02.013.012.007.005z"/>
                    <path fill-rule="evenodd" d="M11.5 1.246c.832-.855 2.082.168 1.703 1.393l-1.08 3.49c-.02.064-.04.123-.063.177-.022.054-.046.101-.07.142a.682.682 0 0 1-.08.107.618.618 0 0 1-.11.095.542.542 0 0 1-.145.066.454.454 0 0 1-.16.023h-.001a.454.454 0 0 1-.16-.023.542.542 0 0 1-.145-.066.618.618 0 0 1-.11-.095.682.682 0 0 1-.08-.107 1.26 1.26 0 0 1-.07-.142 2.313 2.313 0 0 1-.063-.178l-1.08-3.49c-.379-1.224.87-2.247 1.703-1.393l1.008 1.036 1.008-1.036zm-8 0c-.832-.855-2.082.168-1.703 1.393l1.08 3.49c.02.064.04.123.063.177.022.054.046.101.07.142a.682.682 0 0 0 .08.107.618.618 0 0 0 .11.095.542.542 0 0 0 .145.066.454.454 0 0 0 .16.023h.001c.056 0 .11-.008.16-.023a.542.542 0 0 0 .145-.066.618.618 0 0 0 .11-.095.682.682 0 0 0 .08-.107c.024-.04.048-.088.07-.142.022-.054.043-.113.063-.178l1.08-3.49c.379-1.224-.87-2.247-1.703-1.393L3.5 2.28l-1-1.035z"/>
                </svg>
                Pull Request
            </h6>
            <a href="@Status.PrUrl" target="_blank" class="badge bg-secondary text-decoration-none">
                PR #@Status.PrNumber <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/><path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/></svg>
            </a>
        </div>
        <div class="d-flex flex-wrap gap-1 align-items-center">
            <span class="badge @GetPrStatusBadgeClass()">@GetPrStatusDisplay()</span>
            @if (Status.ChecksPassing.HasValue)
            {
                <span class="badge @(Status.ChecksPassing.Value ? "bg-success" : "bg-danger")">
                    @if (Status.ChecksPassing.Value)
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="me-1" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/></svg>
                        <text>Checks Passing</text>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="me-1" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                        <text>Checks Failing</text>
                    }
                </span>
            }
            else if (Status.ChecksRunning)
            {
                <span class="badge bg-warning text-dark">
                    <span class="spinner-border spinner-border-sm me-1" role="status" style="width: 0.5rem; height: 0.5rem;"></span>
                    Checks Running
                </span>
            }
            @if (Status.IsApproved == true)
            {
                <span class="badge bg-success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="me-1" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/></svg>
                    Approved (@Status.ApprovalCount)
                </span>
            }
            else if (Status.ChangesRequestedCount > 0)
            {
                <span class="badge bg-warning text-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="me-1" viewBox="0 0 16 16"><path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0L7.1 4.995z"/></svg>
                    Changes Requested (@Status.ChangesRequestedCount)
                </span>
            }
            @if (Status.IsMergeable)
            {
                <span class="badge bg-success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="me-1" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/></svg>
                    Ready to Merge
                </span>
            }
            @if (Status.HasConflicts)
            {
                <span class="badge bg-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="me-1" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                    Merge Conflicts
                </span>
            }
        </div>
    </div>
}

@code {
    /// <summary>
    /// The PR status to display.
    /// </summary>
    [Parameter]
    public IssuePullRequestStatus? Status { get; set; }

    /// <summary>
    /// Optional additional CSS classes for the container.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    private string GetPrStatusBadgeClass() => Status?.Status switch
    {
        PullRequestStatus.InProgress => "bg-primary",
        PullRequestStatus.ReadyForReview => "bg-warning text-dark",
        PullRequestStatus.ChecksFailing => "bg-danger",
        PullRequestStatus.Conflict => "bg-danger",
        PullRequestStatus.ReadyForMerging => "bg-success",
        PullRequestStatus.Merged => "bg-purple",
        PullRequestStatus.Closed => "bg-secondary",
        _ => "bg-secondary"
    };

    private string GetPrStatusDisplay() => Status?.Status switch
    {
        PullRequestStatus.InProgress => "In Progress",
        PullRequestStatus.ReadyForReview => "Ready for Review",
        PullRequestStatus.ChecksFailing => "Checks Failing",
        PullRequestStatus.Conflict => "Has Conflicts",
        PullRequestStatus.ReadyForMerging => "Ready to Merge",
        PullRequestStatus.Merged => "Merged",
        PullRequestStatus.Closed => "Closed",
        _ => "Unknown"
    };
}

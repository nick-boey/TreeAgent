@using Homespun.Features.GitHub
@using Homespun.Features.OpenCode.Services
@using Homespun.Features.PullRequests.Data
@using Homespun.Features.PullRequests.Data.Entities
@inject PullRequestDataService PullRequestDataService
@inject IGitHubService GitHubService
@inject IAgentWorkflowService AgentWorkflowService

<div class="card pull-request-detail-panel">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Pull Request Details</span>
        <button type="button" class="btn-close" @onclick="OnClose"></button>
    </div>
    <div class="card-body">
        <h5 class="card-title">@PullRequest.Title</h5>

        <div class="mb-3">
            <span class="badge @GetStatusBadgeClass()">@PullRequest.Status</span>
            @if (PullRequest.GitHubPRNumber.HasValue)
            {
                <a href="https://github.com/@PullRequest.Project.GitHubOwner/@PullRequest.Project?.GitHubRepo/pull/@PullRequest.GitHubPRNumber"
                   target="_blank"
                   class="badge bg-secondary text-decoration-none ms-1">
                    PR #@PullRequest.GitHubPRNumber
                </a>
            }
            @if (_agentStatus != null)
            {
                <span class="badge bg-success ms-1">Agent Running</span>
            }
        </div>

        @if (!string.IsNullOrEmpty(PullRequest.Description))
        {
            <p class="card-text">@PullRequest.Description</p>
        }

        <dl class="row small">
            @if (!string.IsNullOrEmpty(PullRequest.BeadsIssueId))
            {
                <dt class="col-4">Linked Issue</dt>
                <dd class="col-8">
                    <span class="badge bg-info text-dark">@PullRequest.BeadsIssueId</span>
                </dd>
            }
            @if (!string.IsNullOrEmpty(PullRequest.BranchName))
            {
                <dt class="col-4">Branch</dt>
                <dd class="col-8"><code>@PullRequest.BranchName</code></dd>
            }
            @if (!string.IsNullOrEmpty(PullRequest.WorktreePath))
            {
                <dt class="col-4">Worktree</dt>
                <dd class="col-8"><code>@PullRequest.WorktreePath</code></dd>
            }
            <dt class="col-4">Created</dt>
            <dd class="col-8">@PullRequest.CreatedAt.ToLocalTime().ToString("g")</dd>
            <dt class="col-4">Updated</dt>
            <dd class="col-8">@PullRequest.UpdatedAt.ToLocalTime().ToString("g")</dd>
        </dl>

        @* Agent Status Display *@
        @if (_agentStatus != null)
        {
            <div class="border-top pt-3 mt-3">
                <h6>OpenCode Agent</h6>
                <div class="mb-2">
                    <span class="badge bg-success">Running</span>
                    @if (_agentStatus.Server.WebViewUrl != null)
                    {
                        <a href="@_agentStatus.Server.WebViewUrl" target="_blank" 
                           class="btn btn-sm btn-outline-primary ms-2">
                            Open Web View
                        </a>
                    }
                    else
                    {
                        <span class="text-muted ms-2">Session initializing...</span>
                    }
                </div>
                <div class="mb-2">
                    <small class="text-muted">
                        Server: <code>@_agentStatus.Server.BaseUrl</code>
                    </small>
                    @if (_agentStatus.ActiveSession != null)
                    {
                        <br/>
                        <small class="text-muted">
                            Session: <code>@_agentStatus.ActiveSession.Id</code>
                        </small>
                    }
                </div>
                @if (!string.IsNullOrEmpty(_agentErrorMessage))
                {
                    <div class="alert alert-danger mt-2 mb-0 py-1 px-2 small">@_agentErrorMessage</div>
                }
            </div>
        }
    </div>
    <div class="card-footer">
        <div class="d-flex flex-wrap gap-2">
            @* Skip review - only when Ready for Review *@
            @if (PullRequest.Status == OpenPullRequestStatus.ReadyForReview)
            {
                <button class="btn btn-sm btn-outline-warning" @onclick="SkipReview" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    }
                    Skip Review
                </button>
            }

            @* Start/Stop Agent - available for all statuses *@
            @if (_agentStatus != null)
            {
                <button class="btn btn-sm btn-outline-danger" @onclick="StopAgent" disabled="@_isAgentLoading">
                    @if (_isAgentLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    }
                    Stop Agent
                </button>
            }
            else
            {
                <div class="d-flex gap-2 align-items-center">
                    <select class="form-select form-select-sm" style="width: auto;" @bind="_selectedModel">
                        <option value="anthropic/claude-opus-4">Opus 4</option>
                        <option value="anthropic/claude-sonnet-4-5">Sonnet 4.5</option>
                        <option value="anthropic/claude-haiku-4-5">Haiku 4.5</option>
                    </select>
                    <button class="btn btn-sm btn-success" @onclick="StartAgent"
                            disabled="@StartAgentDisabled">
                        @if (_isAgentLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        }
                        Start Agent
                    </button>
                </div>
            }

            @* Merge - only when Approved *@
            @if (PullRequest is { Status: OpenPullRequestStatus.Approved, GitHubPRNumber: not null })
            {
                <button class="btn btn-sm btn-primary" @onclick="MergePullRequest" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    }
                    Merge
                </button>
            }
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mt-2 mb-0 py-1 px-2 small">@_errorMessage</div>
        }
        @if (!string.IsNullOrEmpty(_agentErrorMessage))
        {
            <div class="alert alert-danger mt-2 mb-0 py-1 px-2 small">@_agentErrorMessage</div>
        }
    </div>
</div>

@code {
    [Parameter] public PullRequest PullRequest { get; set; } = null!;

    [Parameter] public EventCallback OnActionCompleted { get; set; }

    [Parameter] public EventCallback OnClose { get; set; }

    private bool _isLoading;
    private string? _errorMessage;
    private bool _isAgentLoading;
    private string? _agentErrorMessage;
    private AgentStatus? _agentStatus;
    private string _selectedModel = "anthropic/claude-opus-4";

    protected override async Task OnParametersSetAsync()
    {
        await RefreshAgentStatus();
    }

    private async Task RefreshAgentStatus()
    {
        try
        {
            _agentStatus = await AgentWorkflowService.GetAgentStatusAsync(PullRequest.Id);
        }
        catch
        {
            _agentStatus = null;
        }
    }

    private async Task StartAgent()
    {
        _isAgentLoading = true;
        _agentErrorMessage = null;
        try
        {
            _agentStatus = await AgentWorkflowService.StartAgentForPullRequestAsync(PullRequest.Id, _selectedModel);
            
            // Update status to InDevelopment (working) when agent starts
            await PullRequestDataService.UpdateStatusAsync(PullRequest.Id, OpenPullRequestStatus.InDevelopment);
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _agentErrorMessage = ex.Message;
        }
        finally
        {
            _isAgentLoading = false;
        }
    }

    private async Task StopAgent()
    {
        _isAgentLoading = true;
        _agentErrorMessage = null;
        try
        {
            await AgentWorkflowService.StopAgentAsync(PullRequest.Id);
            _agentStatus = null;
        }
        catch (Exception ex)
        {
            _agentErrorMessage = ex.Message;
        }
        finally
        {
            _isAgentLoading = false;
        }
    }

    // Agent can be started if there's a branch name (worktree will be created automatically if needed)
    private bool StartAgentDisabled => string.IsNullOrEmpty(PullRequest.BranchName) || _isAgentLoading;


    private async Task SkipReview()
    {
        _isLoading = true;
        _errorMessage = null;
        try
        {
            // Move back to InDevelopment so agent can continue working
            await PullRequestDataService.UpdateStatusAsync(PullRequest.Id, OpenPullRequestStatus.InDevelopment);
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task MergePullRequest()
    {
        if (!PullRequest.GitHubPRNumber.HasValue)
        {
            _errorMessage = "No GitHub PR linked to this pull request.";
            return;
        }

        _isLoading = true;
        _errorMessage = null;
        try
        {
            // Stop agent if running before merge
            if (_agentStatus != null)
            {
                await AgentWorkflowService.StopAgentAsync(PullRequest.Id);
                _agentStatus = null;
            }

            var success = await GitHubService.MergePullRequestAsync(
                PullRequest.ProjectId,
                PullRequest.GitHubPRNumber.Value);

            if (!success)
            {
                _errorMessage = "Failed to merge pull request.";
            }
            else
            {
                // Remove from local tracking after successful merge
                await PullRequestDataService.CompleteAsync(PullRequest.Id);
                await OnActionCompleted.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetStatusBadgeClass()
    {
        return PullRequest.Status switch
        {
            OpenPullRequestStatus.InDevelopment => "bg-primary",
            OpenPullRequestStatus.ReadyForReview => "bg-warning text-dark",
            OpenPullRequestStatus.HasReviewComments => "bg-danger",
            OpenPullRequestStatus.Approved => "bg-success",
            _ => "bg-secondary"
        };
    }

}

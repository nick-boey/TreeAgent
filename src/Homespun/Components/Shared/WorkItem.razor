@using Homespun.Features.Agents.Services
@using Homespun.Features.OpenCode.Services
@using Homespun.Features.PullRequests
@using Homespun.Features.PullRequests.Data.Entities

<div class="work-item @(IsSelected ? "selected" : "") @(IsClickable ? "clickable" : "") @(IsLast ? "last" : "")"
     style="@GetIndentStyle()"
     @onclick="HandleClick">
    <div class="item-graph">
        <div class="graph-line graph-line-top @(IsFirst ? "hidden" : "")"></div>
        <div class="graph-node @GetEffectiveStatusColor()" title="@GetEffectiveStatusTooltip()"></div>
        <div class="graph-line graph-line-bottom @(IsLast ? "hidden" : "")"></div>
    </div>
    <div class="item-body">
        @if (!string.IsNullOrEmpty(Url))
        {
            <a href="@Url" target="_blank" class="item-title" @onclick:stopPropagation="true">
                @if (Number.HasValue)
                {
                    <span class="item-number">#@Number</span>
                }
                @Title
            </a>
        }
        else
        {
            <span class="item-title">
                @if (Number.HasValue)
                {
                    <span class="item-number">#@Number</span>
                }
                @Title
            </span>
        }
        <div class="item-subtitle-row">
            @if (StartupState == AgentStartupState.Starting)
            {
                <span class="startup-indicator starting">
                    <span class="spinner-border spinner-border-sm" role="status" style="width: 0.5rem; height: 0.5rem;"></span>
                    Starting...
                </span>
            }
            else if (StartupState == AgentStartupState.Failed)
            {
                <span class="startup-indicator failed" title="@StartupErrorMessage">
                    Failed
                </span>
            }
            @if (!string.IsNullOrEmpty(Subtitle))
            {
                <span class="item-subtitle">@Subtitle</span>
            }
        </div>
    </div>
</div>

<style>
    .item-subtitle-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .startup-indicator {
        font-size: 0.6875rem;
        padding: 0.125rem 0.375rem;
        border-radius: var(--radius-sm);
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .startup-indicator.starting {
        background-color: var(--color-warning-bg, #fff3cd);
        color: var(--color-warning-text, #856404);
    }
    
    .startup-indicator.failed {
        background-color: var(--color-danger-bg, #f8d7da);
        color: var(--color-danger-text, #721c24);
        cursor: help;
    }
</style>

@code {
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public int? Number { get; set; }
    [Parameter] public string? Url { get; set; }
    [Parameter] public string StatusColor { get; set; } = "status-default";
    [Parameter] public string? StatusTooltip { get; set; }
    [Parameter] public string? Subtitle { get; set; }
    [Parameter] public int IndentLevel { get; set; } = 0;
    [Parameter] public bool IsSelected { get; set; }
    [Parameter] public bool IsClickable { get; set; }
    [Parameter] public bool IsFirst { get; set; }
    [Parameter] public bool IsLast { get; set; }
    [Parameter] public EventCallback OnClick { get; set; }
    
    /// <summary>
    /// Optional agent startup state for this work item.
    /// </summary>
    [Parameter] public AgentStartupState? StartupState { get; set; }
    
    /// <summary>
    /// Error message when StartupState is Failed.
    /// </summary>
    [Parameter] public string? StartupErrorMessage { get; set; }

    private string GetIndentStyle()
    {
        if (IndentLevel <= 0) return "";
        return $"margin-left: {IndentLevel * 16}px;";
    }

    private string GetEffectiveStatusColor()
    {
        // Override status color when agent is starting
        if (StartupState == AgentStartupState.Starting)
        {
            return "status-starting";
        }
        if (StartupState == AgentStartupState.Failed)
        {
            return "status-failed";
        }
        return StatusColor;
    }

    private string GetEffectiveStatusTooltip()
    {
        if (StartupState == AgentStartupState.Starting)
        {
            return "Agent starting...";
        }
        if (StartupState == AgentStartupState.Failed)
        {
            return $"Agent failed: {StartupErrorMessage}";
        }
        return StatusTooltip ?? "";
    }

    private async Task HandleClick()
    {
        if (IsClickable && OnClick.HasDelegate)
        {
            await OnClick.InvokeAsync();
        }
    }
}

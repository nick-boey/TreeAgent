@using Homespun.Features.OpenCode.Services
@using Homespun.Features.Roadmap

@inject IAgentWorkflowService AgentWorkflowService
@inject NavigationManager NavigationManager

<div class="card future-change-detail-panel">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Future Change Details</span>
        <button type="button" class="btn-close" @onclick="OnClose"></button>
    </div>
    <div class="card-body">
        <h5 class="card-title">@Change.Title</h5>

        <div class="mb-3">
            <span class="badge @GetTypeBadgeClass()">@Change.Type</span>
            <span class="badge @GetStatusBadgeClass() ms-1">@Change.Status</span>
            @if (Change.Priority.HasValue)
            {
                <span class="badge @GetPriorityBadgeClass() ms-1">@Change.Priority</span>
            }
            @if (_agentStatus != null)
            {
                <span class="badge bg-success ms-1">Agent Running</span>
            }
        </div>

        @if (!string.IsNullOrEmpty(Change.Description))
        {
            <p class="card-text">@Change.Description</p>
        }

        <dl class="row small">
            <dt class="col-4">Branch</dt>
            <dd class="col-8"><code>@Change.Id</code></dd>
            
            <dt class="col-4">Group</dt>
            <dd class="col-8">@Change.Group</dd>
            
            @if (Change.EstimatedComplexity.HasValue)
            {
                <dt class="col-4">Complexity</dt>
                <dd class="col-8">@Change.EstimatedComplexity</dd>
            }
            
            @if (Change.Parents.Count > 0)
            {
                <dt class="col-4">Dependencies</dt>
                <dd class="col-8">
                    @foreach (var parent in Change.Parents)
                    {
                        <code class="me-1">@parent</code>
                    }
                </dd>
            }
        </dl>

        @if (!string.IsNullOrEmpty(Change.Instructions))
        {
            <div class="border-top pt-3 mt-3">
                <h6>Instructions</h6>
                <div class="instructions-content small">
                    <pre class="mb-0">@Change.Instructions</pre>
                </div>
            </div>
        }

        @* Agent Status Display *@
        @if (_agentStatus != null)
        {
            <div class="border-top pt-3 mt-3">
                <h6>OpenCode Agent</h6>
                <div class="mb-2">
                    <span class="badge bg-success">Running</span>
                    <a href="@_agentStatus.Server.BaseUrl" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                        Open Web View
                    </a>
                </div>
                <div class="mb-2">
                    <small class="text-muted">
                        Server: <code>@_agentStatus.Server.BaseUrl</code>
                    </small>
                </div>
            </div>
        }
    </div>
    <div class="card-footer">
        <div class="d-flex flex-wrap gap-2">
            @if (_agentStatus != null)
            {
                <button class="btn btn-sm btn-outline-danger" @onclick="StopAgent" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    }
                    Stop Agent
                </button>
            }
            else if (Change.Status == FutureChangeStatus.Pending)
            {
                <button class="btn btn-sm btn-success" @onclick="StartDevelopment" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    }
                    Start Development
                </button>
            }
            else if (Change.Status == FutureChangeStatus.InProgress && _agentStatus == null)
            {
                <button class="btn btn-sm btn-success" @onclick="ResumeAgent" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    }
                    Resume Agent
                </button>
            }

            <a href="projects/@ProjectId/features/@System.Uri.EscapeDataString(Change.Id)/edit" 
               class="btn btn-sm btn-outline-secondary">
                Edit
            </a>
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mt-2 mb-0 py-1 px-2 small">@_errorMessage</div>
        }
    </div>
</div>

<style>
    .instructions-content pre {
        background-color: var(--bg-secondary);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.75rem;
        max-height: 200px;
        overflow-y: auto;
    }
</style>

@code {
    [Parameter] public required string ProjectId { get; set; }
    
    [Parameter] public required FutureChange Change { get; set; }

    [Parameter] public EventCallback OnActionCompleted { get; set; }

    [Parameter] public EventCallback OnClose { get; set; }

    private bool _isLoading;
    private string? _errorMessage;
    private AgentStatus? _agentStatus;

    protected override async Task OnParametersSetAsync()
    {
        _agentStatus = null;
        _errorMessage = null;
        
        // If the change is in progress, there might be an agent running
        if (Change.Status == FutureChangeStatus.InProgress || Change.Status == FutureChangeStatus.AwaitingPR)
        {
            await TryRefreshAgentStatus();
        }
    }

    private async Task TryRefreshAgentStatus()
    {
        try
        {
            // Use the change ID directly to get agent status
            _agentStatus = await AgentWorkflowService.GetAgentStatusForChangeAsync(Change.Id);
        }
        catch
        {
            _agentStatus = null;
        }
    }

    private async Task StartDevelopment()
    {
        _isLoading = true;
        _errorMessage = null;
        try
        {
            // Creates branch/worktree, starts agent, and sends initial prompt
            // The FutureChange stays in the roadmap with InProgress status until a GitHub PR is created
            _agentStatus = await AgentWorkflowService.StartAgentForFutureChangeAsync(ProjectId, Change.Id);
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ResumeAgent()
    {
        _isLoading = true;
        _errorMessage = null;
        try
        {
            // Resume development on an InProgress change
            // Uses the existing worktree and starts a new agent session
            _agentStatus = await AgentWorkflowService.StartAgentForFutureChangeAsync(ProjectId, Change.Id);
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task StopAgent()
    {
        if (_agentStatus == null)
        {
            return;
        }

        _isLoading = true;
        _errorMessage = null;
        try
        {
            // Stop the agent using the change ID
            // This will also check for a GitHub PR and transition the change appropriately
            await AgentWorkflowService.StopAgentAsync(Change.Id);
            _agentStatus = null;
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetTypeBadgeClass() => Change.Type switch
    {
        ChangeType.Feature => "bg-primary",
        ChangeType.Bug => "bg-danger",
        ChangeType.Refactor => "bg-info",
        ChangeType.Docs => "bg-secondary",
        ChangeType.Test => "bg-warning text-dark",
        ChangeType.Chore => "bg-dark",
        _ => "bg-secondary"
    };

    private string GetStatusBadgeClass() => Change.Status switch
    {
        FutureChangeStatus.Pending => "bg-secondary",
        FutureChangeStatus.InProgress => "bg-primary",
        FutureChangeStatus.AwaitingPR => "bg-info",
        FutureChangeStatus.Complete => "bg-success",
        _ => "bg-secondary"
    };

    private string GetPriorityBadgeClass() => Change.Priority switch
    {
        Priority.High => "bg-danger",
        Priority.Medium => "bg-warning text-dark",
        Priority.Low => "bg-info",
        _ => "bg-secondary"
    };
}

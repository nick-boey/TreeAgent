@using Fleece.Core.Models
@using Homespun.Features.ClaudeCode.Data
@using Homespun.Features.ClaudeCode.Services
@using Homespun.Features.Fleece.Services
@using Homespun.Features.Git
@using Homespun.Features.GitHub
@using Homespun.Features.Projects
@using Homespun.Features.PullRequests
@using Homespun.Features.PullRequests.Data.Entities
@using Homespun.Features.Shared.Services

@inject IClaudeSessionStore SessionStore
@inject IClaudeSessionService SessionService
@inject IAgentStartupTracker StartupTracker
@inject IAgentPromptService AgentPromptService
@inject IFleeceService FleeceService
@inject IGitWorktreeService GitWorktreeService
@inject IRebaseAgentService RebaseAgentService
@inject IIssuePrStatusService IssuePrStatusService
@inject PullRequestWorkflowService PullRequestWorkflowService
@inject IProjectService ProjectService
@inject NavigationManager NavigationManager
@inject ILogger<IssueDetailPanel> Logger
@inject IMarkdownRenderingService MarkdownService

<div class="card issue-detail-panel">
    <div class="card-header flex justify-between items-center">
        <span>Issue Details</span>
        <div class="flex gap-1">
            <a href="projects/@ProjectId/issues/@Issue.Id/edit" class="btn btn-sm btn-outline-secondary" title="Edit issue">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                </svg>
            </a>
            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="HandleClose" title="Close panel">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="card-body">
            <h5 class="card-title">@Issue.Title</h5>

            <div class="mb-3">
                <span class="badge bg-secondary">@Issue.Id</span>
                <span class="badge @GetTypeBadgeClass() ml-1">@Issue.Type</span>
                <span class="badge @GetStatusBadgeClass() ml-1">@GetStatusDisplay()</span>
                @if (Issue.Priority.HasValue)
                {
                    <span class="badge @GetPriorityBadgeClass() ml-1">P@Issue.Priority</span>
                }
                @if (StartupTracker.IsStarting(Issue.Id))
                {
                    <span class="badge bg-status-warning text-text-primary ml-1">
                        <span class="spinner-border spinner-border-sm mr-1" role="status" style="width: 0.6rem; height: 0.6rem;"></span>
                        Starting...
                    </span>
                }
                else if (_session != null)
                {
                    <span class="badge bg-status-success ml-1">Session Active</span>
                }
            </div>

            @if (!string.IsNullOrEmpty(Issue.Description))
            {
                <div class="description-content markdown-content mb-3">
                    @((MarkupString)MarkdownService.RenderToHtml(Issue.Description))
                </div>
            }

            @* Pull Request Status Section *@
            @if (_prStatus != null)
            {
                <div class="pr-status-section border rounded p-2 mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <h6 class="mb-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="mr-1 inline" viewBox="0 0 16 16">
                                <path d="M7.177 11.396c.112.492.227.905.341 1.24a3.19 3.19 0 0 0-.337.247c-.385.334-.718.77-.987 1.284h-.107c-.269-.514-.602-.95-.987-1.284a3.19 3.19 0 0 0-.337-.247c.114-.335.229-.748.341-1.24.188-.835.293-1.843.293-2.896s-.105-2.06-.293-2.896c-.112-.492-.227-.905-.341-1.24a3.19 3.19 0 0 0 .337-.247c.385-.334.718-.77.987-1.284h.107c.269.514.602.95.987 1.284.148.128.308.242.477.341-.016.028-.031.057-.046.086l-.015.03c-.054.114-.087.233-.1.355a11.6 11.6 0 0 0-.063.77v.003c-.008.19-.014.379-.014.565 0 .239.008.474.023.702.015.213.04.42.077.617.035.19.083.374.145.543.062.169.135.32.218.447a1.72 1.72 0 0 0 .148.19l.143.149c.023.022.046.046.07.068.021.019.042.038.064.056l.023.02.024.02.013.012.007.005z"/>
                                <path fill-rule="evenodd" d="M11.5 1.246c.832-.855 2.082.168 1.703 1.393l-1.08 3.49c-.02.064-.04.123-.063.177-.022.054-.046.101-.07.142a.682.682 0 0 1-.08.107.618.618 0 0 1-.11.095.542.542 0 0 1-.145.066.454.454 0 0 1-.16.023h-.001a.454.454 0 0 1-.16-.023.542.542 0 0 1-.145-.066.618.618 0 0 1-.11-.095.682.682 0 0 1-.08-.107 1.26 1.26 0 0 1-.07-.142 2.313 2.313 0 0 1-.063-.178l-1.08-3.49c-.379-1.224.87-2.247 1.703-1.393l1.008 1.036 1.008-1.036zm-8 0c-.832-.855-2.082.168-1.703 1.393l1.08 3.49c.02.064.04.123.063.177.022.054.046.101.07.142a.682.682 0 0 0 .08.107.618.618 0 0 0 .11.095.542.542 0 0 0 .145.066.454.454 0 0 0 .16.023h.001c.056 0 .11-.008.16-.023a.542.542 0 0 0 .145-.066.618.618 0 0 0 .11-.095.682.682 0 0 0 .08-.107c.024-.04.048-.088.07-.142.022-.054.043-.113.063-.178l1.08-3.49c.379-1.224-.87-2.247-1.703-1.393L3.5 2.28l-1-1.035z"/>
                            </svg>
                            Pull Request
                        </h6>
                        <a href="@_prStatus.PrUrl" target="_blank" class="badge bg-secondary no-underline">
                            PR #@_prStatus.PrNumber <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/><path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/></svg>
                        </a>
                    </div>
                    <div class="flex flex-wrap gap-1 items-center">
                        <span class="badge @GetPrStatusBadgeClass()">@GetPrStatusDisplay()</span>
                        @if (_prStatus.ChecksPassing.HasValue)
                        {
                            <span class="badge @(_prStatus.ChecksPassing.Value ? "bg-success" : "bg-danger")">
                                @if (_prStatus.ChecksPassing.Value)
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="mr-1 inline" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/></svg>
                                    <text>Checks Passing</text>
                                }
                                else
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="mr-1 inline" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                                    <text>Checks Failing</text>
                                }
                            </span>
                        }
                        else if (_prStatus.ChecksRunning)
                        {
                            <span class="badge bg-warning text-dark">
                                <span class="spinner-border spinner-border-sm mr-1" role="status" style="width: 0.5rem; height: 0.5rem;"></span>
                                Checks Running
                            </span>
                        }
                        @if (_prStatus.IsApproved == true)
                        {
                            <span class="badge bg-success">
                                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="mr-1 inline" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/></svg>
                                Approved (@_prStatus.ApprovalCount)
                            </span>
                        }
                        else if (_prStatus.ChangesRequestedCount > 0)
                        {
                            <span class="badge bg-warning text-dark">
                                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="mr-1 inline" viewBox="0 0 16 16"><path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0L7.1 4.995z"/></svg>
                                Changes Requested (@_prStatus.ChangesRequestedCount)
                            </span>
                        }
                        @if (_prStatus.IsMergeable)
                        {
                            <span class="badge bg-success">
                                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="mr-1 inline" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/></svg>
                                Ready to Merge
                            </span>
                        }
                        @if (_prStatus.HasConflicts)
                        {
                            <span class="badge bg-danger">
                                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="mr-1 inline" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                                Merge Conflicts
                            </span>
                        }
                    </div>
                </div>
            }
            @if (_isLoadingPrStatus)
            {
                <div class="text-text-muted text-sm mb-3">
                    <span class="spinner-border spinner-border-sm mr-1" role="status" style="width: 0.6rem; height: 0.6rem;"></span>
                    Loading PR status...
                </div>
            }

            <dl class="grid grid-cols-12 text-sm">
                <dt class="col-span-4">Branch Preview</dt>
                <dd class="col-span-8"><code>@GetBranchPreview()</code></dd>

                @if (Issue.ParentIssues.Count > 0)
                {
                    <dt class="col-span-4">Parent Issues</dt>
                    <dd class="col-span-8">
                        @foreach (var parentId in Issue.ParentIssues)
                        {
                            <code class="mr-1">@parentId</code>
                        }
                    </dd>
                }
            </dl>

            @* Session Status Display *@
            @if (_session != null)
            {
                <div class="border-top pt-3 mt-3">
                    <h6>Claude Code Session</h6>
                    <div class="mb-2">
                        <span class="badge @GetSessionStatusBadgeClass()">@_session.Status</span>
                        <a href="/session/@_session.Id" class="btn btn-sm btn-outline-primary ml-2">
                            Open Chat
                        </a>
                    </div>
                    <div class="mb-2">
                        <small class="text-text-muted">
                            Mode: <code>@_session.Mode</code>
                        </small>
                        <br/>
                        <small class="text-text-muted">
                            Model: <code>@_session.Model</code>
                        </small>
                    </div>
                </div>
            }
        </div>
        <div class="card-footer">
            @if (_session == null && !StartupTracker.IsStarting(Issue.Id))
            {
                <div class="mb-2">
                    <label class="form-label text-sm mb-1">Model</label>
                    <ModelSelector Id="@($"issue-model-{Issue.Id}")"
                                   SelectedModel="@_selectedModel"
                                   SelectedModelChanged="@(m => _selectedModel = m)" />
                </div>
            }

            <div class="flex flex-wrap gap-2">
                @if (StartupTracker.IsStarting(Issue.Id))
                {
                    <button class="btn btn-sm btn-secondary" disabled>
                        <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                        Starting Session...
                    </button>
                }
                else if (_session != null)
                {
                    <a href="/session/@_session.Id" class="btn btn-sm btn-primary">
                        Open Chat
                    </a>
                    <button class="btn btn-sm btn-outline-danger" @onclick="StopSession" disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                        }
                        Stop Session
                    </button>
                }
                else if (Issue.Status is IssueStatus.Idea or IssueStatus.Spec or IssueStatus.Next or IssueStatus.Progress or IssueStatus.Review)
                {
                    <div class="mb-2 w-full">
                        <AgentSelector
                            Disabled="@(_session != null)"
                            IsStarting="@StartupTracker.IsStarting(Issue.Id)"
                            OnStart="HandleAgentStart" />
                    </div>

                    @if (_worktreeInfo != null && _branchInfo?.BehindCount > 0)
                    {
                        <button class="btn btn-sm btn-outline-warning w-full mb-2"
                                @onclick="StartRebaseAsync"
                                disabled="@(_isRebasing || StartupTracker.IsStarting(Issue.Id))">
                            @if (_isRebasing)
                            {
                                <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                            }
                            Rebase onto @_project?.DefaultBranch (@_branchInfo.BehindCount behind)
                        </button>
                    }
                }
            </div>

            <div class="flex flex-wrap gap-2">
                @if (Issue.Status is IssueStatus.Idea or IssueStatus.Spec or IssueStatus.Next or IssueStatus.Progress or IssueStatus.Review)
                {
                    <button class="btn btn-sm btn-outline-primary" @onclick="CloseIssue" disabled="@_isLoading" title="Mark issue as completed">
                        Close Issue
                    </button>
                }

                <button class="btn btn-sm btn-outline-danger" @onclick="ShowDeleteConfirmation" disabled="@_isLoading" title="Delete issue permanently">
                    Delete
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger mt-2 mb-0 py-1 px-2 text-sm">@_errorMessage</div>
            }
        </div>

        @if (_showDeleteConfirmation)
        {
            <div class="modal-backdrop fade show" style="background-color: rgba(0,0,0,0.5);"></div>
            <div class="modal fade show block" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Delete Issue</h5>
                            <button type="button" class="btn-close" @onclick="HideDeleteConfirmation"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete issue <strong>@Issue.Id</strong>?</p>
                            <p class="mb-0">This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="HideDeleteConfirmation">Cancel</button>
                            <button type="button" class="btn btn-danger" @onclick="DeleteIssue" disabled="@_isLoading">
                                @if (_isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                                }
                                Delete Issue
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
</div>


@code {
    [Parameter] public required string ProjectId { get; set; }

    [Parameter] public required Issue Issue { get; set; }

    [Parameter] public EventCallback OnActionCompleted { get; set; }

    [Parameter] public EventCallback OnClose { get; set; }

    private bool _isLoading;
    private bool _showDeleteConfirmation;
    private string? _errorMessage;
    private ClaudeSession? _session;
    private Project? _project;
    private string _selectedModel = "opus";
    private WorktreeInfo? _worktreeInfo;
    private BranchInfo? _branchInfo;
    private bool _isRebasing;
    private IssuePullRequestStatus? _prStatus;
    private bool _isLoadingPrStatus;

    protected override async Task OnInitializedAsync()
    {
        // Load project info
        _project = await ProjectService.GetByIdAsync(ProjectId);

        // Set default model from project if available
        if (_project?.DefaultModel != null)
        {
            _selectedModel = _project.DefaultModel;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        _session = null;
        _errorMessage = null;
        _worktreeInfo = null;
        _branchInfo = null;
        _prStatus = null;

        // Check for existing session
        _session = SessionStore.GetByEntityId(Issue.Id);

        // Load worktree and branch info if project is available
        if (_project != null)
        {
            await LoadWorktreeInfoAsync();
            // Load PR status in background to not block UI
            _ = LoadPrStatusAsync();
        }
    }

    private async Task LoadPrStatusAsync()
    {
        _isLoadingPrStatus = true;
        StateHasChanged();

        try
        {
            _prStatus = await IssuePrStatusService.GetPullRequestStatusForIssueAsync(ProjectId, Issue.Id);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load PR status for issue {IssueId}", Issue.Id);
        }
        finally
        {
            _isLoadingPrStatus = false;
            StateHasChanged();
        }
    }

    private async Task LoadWorktreeInfoAsync()
    {
        if (_project == null) return;

        try
        {
            var branchName = GetBranchPreview();
            var worktrees = await GitWorktreeService.ListWorktreesAsync(_project.LocalPath);
            _worktreeInfo = worktrees.FirstOrDefault(w =>
                w.Branch?.Replace("refs/heads/", "") == branchName);

            if (_worktreeInfo != null)
            {
                var branches = await GitWorktreeService.ListLocalBranchesAsync(_project.LocalPath);
                _branchInfo = branches.FirstOrDefault(b => b.ShortName == branchName);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load worktree info for issue {IssueId}", Issue.Id);
        }
    }

    private void HandleClose()
    {
        OnClose.InvokeAsync();
    }

    private string GetBranchPreview()
    {
        return $"issues/{Issue.Type.ToString().ToLowerInvariant()}/{SanitizeForBranch(Issue.Title)}+{Issue.Id}";
    }

    private static string SanitizeForBranch(string input)
    {
        // Convert to lowercase, replace spaces with hyphens, remove special chars
        var sanitized = input.ToLowerInvariant()
            .Replace(" ", "-")
            .Replace("_", "-");

        // Remove any character that isn't alphanumeric or hyphen
        sanitized = System.Text.RegularExpressions.Regex.Replace(sanitized, "[^a-z0-9-]", "");

        // Remove consecutive hyphens
        sanitized = System.Text.RegularExpressions.Regex.Replace(sanitized, "-+", "-");

        // Trim hyphens from start and end
        return sanitized.Trim('-');
    }

    private async Task HandleAgentStart(AgentPrompt? selectedPrompt)
    {
        await StartSession(selectedPrompt);
    }

    private async Task StartSession(AgentPrompt? prompt)
    {
        if (_project == null)
        {
            _errorMessage = "Project not available.";
            return;
        }

        StartupTracker.MarkAsStarting(Issue.Id);
        _errorMessage = null;

        try
        {
            // Create worktree for the issue's branch
            var branchName = GetBranchPreview();
            Logger.LogInformation("Creating worktree for branch {BranchName} from {ProjectPath}", branchName, _project.LocalPath);

            var worktreePath = await GitWorktreeService.CreateWorktreeAsync(
                _project.LocalPath,
                branchName,
                createBranch: true,
                baseBranch: _project.DefaultBranch);

            if (string.IsNullOrEmpty(worktreePath))
            {
                _errorMessage = "Failed to create worktree for issue branch.";
                StartupTracker.MarkAsFailed(Issue.Id, _errorMessage);
                return;
            }

            Logger.LogInformation("Created worktree at {WorktreePath} for issue {IssueId}", worktreePath, Issue.Id);

            // Use the prompt's mode, or default to Build if no prompt selected
            var mode = prompt?.Mode ?? SessionMode.Build;

            var systemPrompt = GenerateSystemPrompt();
            _session = await SessionService.StartSessionAsync(
                Issue.Id,
                ProjectId,
                worktreePath,
                mode,
                _selectedModel,
                systemPrompt);

            StartupTracker.MarkAsStarted(Issue.Id);

            // Send an initial message to start the agent working (if a prompt is selected)
            if (prompt != null && !string.IsNullOrEmpty(prompt.InitialMessage))
            {
                var context = new PromptContext
                {
                    Title = Issue.Title,
                    Id = Issue.Id,
                    Description = Issue.Description,
                    Branch = branchName,
                    Type = Issue.Type.ToString()
                };
                var initialMessage = AgentPromptService.RenderTemplate(prompt.InitialMessage, context);
                if (!string.IsNullOrEmpty(initialMessage))
                {
                    await SessionService.SendMessageAsync(_session.Id, initialMessage);
                }
            }

            // Agent started - user stays on current page and can monitor via status indicator
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to start session for issue {IssueId}", Issue.Id);
            StartupTracker.MarkAsFailed(Issue.Id, ex.Message);
            _errorMessage = $"Failed to start session: {ex.Message}";
            _session = null;
        }
    }

    private string? GenerateSystemPrompt()
    {
        // Build a context-aware system prompt based on the issue
        var sb = new System.Text.StringBuilder();
        sb.AppendLine($"You are working on issue {Issue.Id}: {Issue.Title}");

        if (!string.IsNullOrEmpty(Issue.Description))
        {
            sb.AppendLine();
            sb.AppendLine("Issue Description:");
            sb.AppendLine(Issue.Description);
        }

        sb.AppendLine();
        sb.AppendLine($"Branch: {GetBranchPreview()}");

        return sb.ToString();
    }

    private async Task StopSession()
    {
        if (_session == null) return;

        _isLoading = true;
        _errorMessage = null;
        try
        {
            await SessionService.StopSessionAsync(_session.Id);
            _session = null;
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task StartRebaseAsync()
    {
        if (_project == null || _worktreeInfo == null)
        {
            _errorMessage = "Project or worktree not available.";
            return;
        }

        var branchName = GetBranchPreview();
        var entityId = $"rebase-{branchName}";

        StartupTracker.MarkAsStarting(entityId);
        _isRebasing = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            // Get recently merged PRs for context
            var recentMergedPRs = await PullRequestWorkflowService.GetMergedPullRequestsWithTimeAsync(_project.Id);
            var recentPRInfos = recentMergedPRs
                .Take(10)
                .Select(pr => pr.PullRequest)
                .ToList();

            var session = await RebaseAgentService.StartRebaseAgentAsync(
                _project.Id,
                _worktreeInfo.Path,
                branchName,
                _project.DefaultBranch,
                _selectedModel,
                recentPRInfos);

            StartupTracker.MarkAsStarted(entityId);

            // Navigate to the session
            NavigationManager.NavigateTo($"/session/{session.Id}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to start rebase agent for issue {IssueId}", Issue.Id);
            StartupTracker.MarkAsFailed(entityId, ex.Message);
            _errorMessage = $"Failed to start rebase agent: {ex.Message}";
        }
        finally
        {
            _isRebasing = false;
            StateHasChanged();
        }
    }

    private async Task CloseIssue()
    {
        if (_project?.LocalPath == null)
        {
            _errorMessage = "Project path not available.";
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        try
        {
            var updated = await FleeceService.UpdateIssueAsync(_project.LocalPath, Issue.Id, status: IssueStatus.Closed);

            if (updated == null)
            {
                _errorMessage = "Failed to close issue.";
                return;
            }
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to close issue: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ShowDeleteConfirmation()
    {
        _showDeleteConfirmation = true;
    }

    private void HideDeleteConfirmation()
    {
        _showDeleteConfirmation = false;
    }

    private async Task DeleteIssue()
    {
        if (_project?.LocalPath == null)
        {
            _errorMessage = "Project path not available.";
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        try
        {
            var success = await FleeceService.DeleteIssueAsync(_project.LocalPath, Issue.Id);

            if (!success)
            {
                _errorMessage = "Failed to delete issue.";
                _showDeleteConfirmation = false;
                return;
            }
            _showDeleteConfirmation = false;
            await OnActionCompleted.InvokeAsync();
            await OnClose.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to delete issue: {ex.Message}";
            _showDeleteConfirmation = false;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetStatusDisplay() => Issue.Status.ToString();

    private string GetTypeBadgeClass() => Issue.Type switch
    {
        IssueType.Feature => "bg-primary",
        IssueType.Bug => "bg-danger",
        IssueType.Task => "bg-info",
        IssueType.Chore => "bg-dark",
        _ => "bg-secondary"
    };

    private string GetStatusBadgeClass() => Issue.Status switch
    {
        IssueStatus.Idea => "bg-purple",
        IssueStatus.Spec => "bg-info",
        IssueStatus.Next => "bg-warning text-dark",
        IssueStatus.Progress => "bg-primary",
        IssueStatus.Review => "bg-info",
        IssueStatus.Complete => "bg-success",
        IssueStatus.Closed => "bg-success",
        IssueStatus.Archived => "bg-light text-dark",
        IssueStatus.Deleted => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetPriorityBadgeClass() => Issue.Priority switch
    {
        0 => "bg-danger",
        1 => "bg-warning text-dark",
        2 => "bg-info",
        3 => "bg-secondary",
        4 => "bg-light text-dark",
        _ => "bg-secondary"
    };

    private string GetSessionStatusBadgeClass() => _session?.Status.ToBadgeClass() ?? "bg-secondary";

    private string GetPrStatusBadgeClass() => _prStatus?.Status switch
    {
        PullRequestStatus.InProgress => "bg-primary",
        PullRequestStatus.ReadyForReview => "bg-warning text-dark",
        PullRequestStatus.ChecksFailing => "bg-danger",
        PullRequestStatus.Conflict => "bg-danger",
        PullRequestStatus.ReadyForMerging => "bg-success",
        PullRequestStatus.Merged => "bg-purple",
        PullRequestStatus.Closed => "bg-secondary",
        _ => "bg-secondary"
    };

    private string GetPrStatusDisplay() => _prStatus?.Status switch
    {
        PullRequestStatus.InProgress => "In Progress",
        PullRequestStatus.ReadyForReview => "Ready for Review",
        PullRequestStatus.ChecksFailing => "Checks Failing",
        PullRequestStatus.Conflict => "Has Conflicts",
        PullRequestStatus.ReadyForMerging => "Ready to Merge",
        PullRequestStatus.Merged => "Merged",
        PullRequestStatus.Closed => "Closed",
        _ => "Unknown"
    };
}

# Homespun Docker Compose Configuration
#
# This configuration runs Homespun with Watchtower for automatic updates.
# Pre-built images are pulled from GitHub Container Registry (GHCR).
#
# Usage:
#   ./scripts/run.sh                    # Production mode with GHCR image + Watchtower
#   ./scripts/run.sh --local            # Development mode with local image (no Watchtower)
#
# Environment variables (set in .env or export before running):
#   GITHUB_TOKEN           - GitHub personal access token (required for PR sync)
#   TAILSCALE_AUTH_KEY     - Tailscale auth key (optional, for remote access via tailnet)
#   TAILSCALE_HOSTNAME     - Tailscale hostname (default: homespun)
#   HSP_EXTERNAL_HOSTNAME  - Full external hostname for agent links (e.g., homespun.tail1234.ts.net)

services:
  # Tailscale sidecar container - provides tailnet access for Homespun
  # When configured, Homespun and OpenCode servers are accessible via:
  #   - http://<hostname>.<tailnet>.ts.net:8080 (Homespun web UI)
  #   - http://<hostname>.<tailnet>.ts.net:4096-4105 (OpenCode servers)
  # Note: Access via port 8080, not 80/443 (no HTTPS termination configured)
  tailscale-homespun:
    image: tailscale/tailscale:latest
    container_name: tailscale-homespun
    hostname: ${TAILSCALE_HOSTNAME:-homespun}
    profiles:
      - tailscale
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY:-}
      - TS_HOSTNAME=${TAILSCALE_HOSTNAME:-homespun}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=${TS_USERSPACE:-true}
      # Serve config to proxy TCP port 8080 to Homespun
      - TS_SERVE_CONFIG=/etc/tailscale/serve.json
    volumes:
      - ${DATA_DIR:-~/.homespun-container/data}/tailscale:/var/lib/tailscale
      - ./tailscale-serve.json:/etc/tailscale/serve.json:ro
    cap_add:
      - net_admin
      - sys_module
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "tailscale", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Homespun without Tailscale (direct port exposure)
  homespun:
    image: ${HOMESPUN_IMAGE:-ghcr.io/nick-boey/homespun:latest}
    container_name: homespun
    # Run as the host user to ensure files created in mounted volumes have correct ownership.
    # HOST_UID and HOST_GID are set by run.sh to the current user's UID/GID.
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    profiles:
      - standalone
    ports:
      - "8080:8080"
    volumes:
      - ${DATA_DIR:-~/.homespun-container/data}:/data
      - ${SSH_DIR:-~/.ssh}:/home/homespun/.ssh:ro
    environment:
      - HOME=/home/homespun
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - ASPNETCORE_ENVIRONMENT=Production
      # Host data path for beads daemon path translation
      # The beads daemon runs on the host and sees the full host path,
      # while the container sees /data. This allows path translation.
      - HSP_HOST_DATA_PATH=${DATA_DIR:-}
      # External hostname for agent URLs (e.g., homespun.tail1234.ts.net)
      - HSP_EXTERNAL_HOSTNAME=${HSP_EXTERNAL_HOSTNAME:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Homespun with Tailscale networking (uses sidecar's network stack)
  homespun-tailscale:
    image: ${HOMESPUN_IMAGE:-ghcr.io/nick-boey/homespun:latest}
    container_name: homespun
    # Run as the host user to ensure files created in mounted volumes have correct ownership.
    # HOST_UID and HOST_GID are set by run.sh to the current user's UID/GID.
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    profiles:
      - tailscale
    depends_on:
      tailscale-homespun:
        condition: service_healthy
    network_mode: service:tailscale-homespun
    volumes:
      - ${DATA_DIR:-~/.homespun-container/data}:/data
      - ${SSH_DIR:-~/.ssh}:/home/homespun/.ssh:ro
    environment:
      - HOME=/home/homespun
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - ASPNETCORE_ENVIRONMENT=Production
      - HSP_HOST_DATA_PATH=${DATA_DIR:-}
      # External hostname for agent URLs (e.g., homespun.tail1234.ts.net)
      - HSP_EXTERNAL_HOSTNAME=${HSP_EXTERNAL_HOSTNAME:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    profiles:
      - production
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=${WATCHTOWER_POLL_INTERVAL:-300}
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_ROLLING_RESTART=true
    restart: unless-stopped
    command: homespun
